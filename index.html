<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>開閉店タスク割り振りBOT</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* モダンデザインのスタイル */
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f4f7fa; 
            color: #334155; 
        }

        /* ★タイトル (黒に変更) */
        h1.title-effect {
            font-size: 2.5rem; /* 4xl (36px) */
            font-weight: 700;
            color: #1e293b; /* Gray-800 (黒っぽい色) */
        }
        @media (min-width: 768px) {
             h1.title-effect {
                font-size: 3rem; /* 5xl (48px) */
             }
        }

        /* タブ (セグメントコントロール風) */
        .tab-container {
            background-color: #e2e8f0; /* Gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.25rem;
            display: flex;
            width: fit-content;
        }
        .tab-button {
            transition: all 0.3s ease;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500;
            color: #475569; /* Gray-600 */
            border: 2px solid transparent;
            font-size: 0.875rem; /* text-sm */
            padding: 0.5rem 1rem;
        }
        .tab-button.active {
            background-color: #ffffff;
            color: #3b82f6; /* Blue-500 */
            font-weight: 600;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
         @media (min-width: 768px) {
            .tab-button {
                font-size: 1rem; /* text-base */
                padding: 0.75rem 1.5rem;
            }
         }
         
        /* サブタブ (開店・閉店) */
        .sub-tab-button {
             font-size: 0.875rem; /* text-sm */
             padding: 0.5rem 1rem;
        }


        /* セクション (カード風) */
        .task-section {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid #e2e8f0; /* Gray-200 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            overflow: hidden; /* テーブルの角丸のため */
        }
        
        .section-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0; /* Gray-200 */
            background-color: #f8fafc; /* Gray-50 */
        }

        .section-title {
            color: #1e293b; /* Gray-800 */
            font-weight: 600;
            font-size: 1.25rem; /* xl */
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        
        .section-content {
            padding: 1rem;
        }
         @media (min-width: 768px) {
             .section-content {
                padding: 1.5rem;
            }
         }

        /* ボタン共通 (インディゴ) */
        .add-button {
            background-color: #4f46e5; /* Indigo-600 */
            color: #ffffff;
            padding: 0.625rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.15s ease-in-out, box-shadow 0.15s ease;
            white-space: nowrap;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .add-button:hover {
            background-color: #4338ca; /* Indigo-700 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        /* 自動割振りボタン (セカンダリ) */
        .secondary-button {
            background-color: #f1f5f9; /* Gray-100 */
            color: #475569; /* Gray-600 */
            border: 1px solid #cbd5e1; /* Gray-300 */
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
         .secondary-button:hover {
            background-color: #e2e8f0; /* Gray-200 */
            box-shadow: none;
         }


        .remove-button {
            background-color: transparent;
            color: #dc2626; /* Red-600 */
            border: 1px solid #ef4444; /* Red-500 */
            border-radius: 9999px; /* rounded-full */
            width: 26px;
            height: 26px;
            font-size: 1.125rem;
            line-height: 1.25;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease-in-out;
            padding-bottom: 2px; /* for &times; centering */
        }
        .remove-button:hover {
            background-color: #dc2626;
            color: #ffffff;
        }
        .remove-task-button {
            width: 22px;
            height: 22px;
            font-size: 1rem;
            color: #64748b; /* Gray-500 */
            border: 1px solid #94a3b8; /* Gray-400 */
            border-radius: 9999px;
        }
         .remove-task-button:hover {
            background-color: #64748b;
            color: #ffffff;
        }
        .add-task-button {
            background-color: #f1f5f9; /* Gray-100 */
            color: #475569; /* Gray-600 */
            border: 1px solid #cbd5e1; /* Gray-300 */
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
        }
        .add-task-button:hover {
             background-color: #e2e8f0; /* Gray-200 */
        }


        /* Table styles (クリーン) */
        .task-table {
            width: 100%;
            border-collapse: collapse; /* ★collapse */
        }

        .task-table th,
        .task-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* Gray-200 */
            vertical-align: middle;
        }
        
        .task-table th {
            font-weight: 600;
            color: #475569; /* Gray-600 */
            text-transform: uppercase;
            font-size: 0.75rem; /* xs */
            letter-spacing: 0.05em;
            background-color: #f8fafc; /* Gray-50 */
        }
        
        /* スタッフ行のスタイル */
        .staff-row td {
            /* 最初のタスク行と同じ */
        }
        /* タスク行のスタイル */
        .task-row td {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px dashed #e2e8f0; /* Gray-200 */
        }
        .task-row:last-child td {
             border-bottom: 1px solid #e2e8f0; /* 最後のタスク行 */
        }
        .task-label {
            text-align: right;
            font-size: 0.875rem;
            color: #64748b;
            padding-right: 0.5rem;
            vertical-align: top;
            padding-top: 0.75rem;
        }
        .staff-name-cell {
            font-weight: 500;
            color: #1e293b;
            font-size: 1.125rem; /* lg */
        }
        
        /* カスタムプルダウン (スマホ対応) */
        .custom-select-button {
            width: 100%;
            text-align: left;
            padding: 0.5rem 0.75rem;
            border: 1px solid #cbd5e1; /* Gray-300 */
            border-radius: 0.375rem;
            background-color: #ffffff;
            min-height: 38px; /* inputの高さと合わせる */
            font-size: 0.875rem; /* text-sm */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* スタッフ追加ボタンのデザイン */
        .staff-select-button {
            padding: 0.625rem 0.75rem; /* 10px 12px */
            min-height: 42px; /* add-buttonと高さを合わせる */
        }
        .staff-select-button.placeholder {
            color: #64748b; /* Gray-500 */
        }
        
        .custom-select-button.placeholder {
            color: #94a3b8; /* Gray-400 */
        }
        .custom-select-button:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .custom-select-button svg {
            width: 1.25rem;
            height: 1.25rem;
            color: #94a3b8;
        }

        /* カスタムモーダル (選択肢用) */
        .select-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        .select-modal-content {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .select-modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
        }
        .select-modal-body {
            overflow-y: auto;
            padding: 0.5rem;
        }
        .select-modal-option {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            border-radius: 0.375rem;
            transition: background-color 0.15s ease-in-out;
            font-size: 1rem;
        }
        .select-modal-option:hover {
            background-color: #f1f5f9; /* Gray-100 */
        }
        .select-modal-option.selected {
            background-color: #dbeafe; /* Blue-100 */
            color: #1d4ed8; /* Blue-700 */
            font-weight: 500;
        }
         .select-modal-option.clear-option {
            color: #64748b;
            font-style: italic;
        }
        .select-modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e2e8f0;
            text-align: right;
        }
        .modal-close-button {
            background-color: #4f46e5; /* Indigo-600 */
            color: #ffffff;
            padding: 0.5rem 1.25rem;
            border-radius: 0.375rem;
            font-weight: 500;
        }
         .modal-close-button:hover {
            background-color: #4338ca;
         }

        
        /* 削除確認モーダル */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(15, 23, 42, 0.5); /* Slate-900 with 50% opacity */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 400px;
            width: 90%;
        }
        
        /* タイムライン（割振り確認）用スタイル */
        .timeline-container {
            width: 100%;
            overflow-x: auto; /* スマホ用に横スクロール */
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        .timeline-table {
            width: 100%;
            min-width: 1000px; /* 横スクロールを強制 */
            border-collapse: collapse;
        }
        .timeline-table th,
        .timeline-table td {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            height: 3.5rem; /* 高さを固定 */
            text-align: left;
            vertical-align: top;
            font-size: 0.875rem;
        }
        .timeline-table thead th {
            background-color: #f8fafc;
            text-align: center;
            vertical-align: middle;
            font-weight: 600;
            color: #475569;
            min-width: 100px; /* 時間セルの最小幅 */
            white-space: nowrap;
        }
        .timeline-table tbody th { /* スタッフ名セル */
            background-color: #f8fafc;
            font-weight: 600;
            color: #1e293b;
            min-width: 150px;
            white-space: nowrap;
            position: sticky; /* ★スタッフ名をスクロール追従 */
            left: 0;
            z-index: 10;
        }
        .timeline-table tbody td {
            position: relative;
        }
        /* タスクバーのスタイル (インディゴ) */
        .task-bar {
            position: absolute;
            top: 4px;
            left: 2px;
            right: 2px;
            bottom: 4px;
            background-color: #c7d2fe; /* Indigo-200 */
            border: 1px solid #818cf8; /* Indigo-400 */
            color: #3730a3; /* Indigo-800 */
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            z-index: 1;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        /* ペアタスクは色を変える */
        .task-bar.pair-task {
            background-color: #fecaca; /* Red-200 */
            border-color: #f87171; /* Red-400 */
            color: #991b1b; /* Red-800 */
        }


        /* レスポンシブ (スマホ用) */
        @media (max-width: 767px) {
            .task-table {
                display: block;
                width: 100%;
            }
            .task-table thead {
                display: none; /* テーブルヘッダー非表示 */
            }
            .task-table tbody, .task-table tr, .task-table td {
                display: block;
                width: 100% !important; /* !importantで幅指定を上書き */
                padding: 0;
                border: 0;
            }
            
            .task-table tr {
                border-bottom: 1px solid #e2e8f0;
                margin-bottom: 1.5rem;
                padding-bottom: 1rem;
            }
            .task-table tr:last-child {
                margin-bottom: 0;
                padding-bottom: 0;
                border-bottom: 0;
            }

            .task-table td {
                padding: 0.5rem 0.25rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            /* TDにラベルを追加 */
            .task-table td:before {
                content: attr(data-label);
                font-weight: 600;
                color: #64748b; /* Gray-500 */
                padding-right: 1rem;
                white-space: nowrap;
            }
            
            .staff-name-cell {
                padding: 0.5rem 0.25rem 1rem 0.25rem; /* 名前だけパディング大きめ */
                font-size: 1.25rem;
            }
            .staff-name-cell:before {
                display: none; /* 名前セルはラベル不要 */
            }
            
            .task-label {
                display: none; /* 元のタスクラベルは非表示 */
            }
            
            /* スマホ用のボタン配置 */
            .task-buttons-cell {
                justify-content: space-around; /* ボタンを均等配置 */
                padding-top: 0.5rem;
            }
             .task-buttons-cell:before {
                display: none; /* ラベル不要 */
             }
            
            .remove-button {
                width: 32px;
                height: 32px;
                font-size: 1.25rem;
            }
            .add-task-button, .remove-task-button {
                width: 30px;
                height: 30px;
                font-size: 1.25rem;
                padding: 0;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }

        }

    </style>
</head>
<body class="p-4 md:p-8 lg:p-10">

    <div class="max-w-7xl mx-auto">

        <!-- ヘッダー -->
        <header class="text-center mb-8">
            <h1 class="title-effect tracking-wide">
                開閉店タスク割り振りBOT
            </h1>
        </header>
        
        <!-- メインチブ (セグメントコントロール風) -->
        <div class="mb-6 md:mb-8 flex justify-center">
            <div class="tab-container">
                <button id="tab-assign" class="tab-button active" onclick="showTab('assign')">
                    タスク割振り
                </button>
                <button id="tab-summary" class="tab-button" onclick="showTab('summary')">
                    割振り確認
                </button>
            </div>
        </div>


        <!-- メインコンテンツ -->
        <main>
            <!-- 「タスク割振り」タブのコンテンツ -->
            <div id="content-assign" class="space-y-6 md:space-y-8">
                <!-- サブタブ（開店・閉店） (セグメントコントロール風) -->
                <div class="mb-6 md:mb-8 flex justify-center">
                    <div class="tab-container">
                        <button id="tab-open" class="tab-button sub-tab-button active" onclick="showSubTab('open')">
                            開店作業 (07:00 - 10:00)
                        </button>
                        <button id="tab-close" class="tab-button sub-tab-button" onclick="showSubTab('close')">
                            閉店作業 (22:50 - 23:30)
                        </button>
                    </div>
                </div>

                <!-- 開店作業エリア -->
                <div id="content-open">
                    <!-- カード型セクションに変更 -->
                    <section class="task-section mb-6 md:mb-8">
                        <div class="section-header flex justify-between items-center">
                            <h2 class="section-title">
                                社員・早番
                            </h2>
                            <button onclick="autoAssignTasks('early', 'open')" class="add-button secondary-button">
                                自動割振り
                            </button>
                        </div>
                        <div class="section-content space-y-4">
                            <!-- スタッフ追加フォーム (カスタムモーダル) -->
                            <div class="flex space-x-2">
                                <button id="add-staff-button-early" 
                                        class="custom-select-button staff-select-button placeholder flex-grow" 
                                        onclick="openStaffSelect('early', 'employees')"
                                        data-placeholder="--- 社員を検索・選択 ---">
                                    <span>--- 社員を検索・選択 ---</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <button onclick="addStaff('early')" class="add-button">追加</button>
                            </div>
                            <!-- スタッフ一覧テーブル -->
                            <div>
                                <table class="task-table">
                                    <thead>
                                        <tr>
                                            <th class="w-1/4">スタッフ名</th>
                                            <th class="w-1/6">開始</th>
                                            <th class="w-1/6">終了</th>
                                            <th class="w-2/5">担当タスク</th>
                                            <th class="w-auto"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="staff-list-open-early">
                                        <!-- スタッフ行はJSで描画 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <section class="task-section mb-6 md:mb-8">
                        <div class="section-header flex justify-between items-center">
                            <h2 class="section-title">
                                早番アルバイト
                            </h2>
                            <button onclick="autoAssignTasks('late', 'open')" class="add-button secondary-button">
                                自動割振り
                            </button>
                        </div>
                        <div class="section-content space-y-4">
                            <!-- スタッフ追加フォーム (カスタムモーダル) -->
                            <div class="flex space-x-2">
                                <button id="add-staff-button-late" 
                                        class="custom-select-button staff-select-button placeholder flex-grow" 
                                        onclick="openStaffSelect('late', 'alba_early')"
                                        data-placeholder="--- 早番アルバイトを検索・選択 ---">
                                    <span>--- 早番アルバイトを検索・選択 ---</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <button onclick="addStaff('late')" class="add-button">追加</button>
                            </div>
                            <div>
                                <table class="task-table">
                                    <thead>
                                        <tr>
                                            <th class="w-1/4">スタッフ名</th>
                                            <th class="w-1/6">開始</th>
                                            <th class="w-1/6">終了</th>
                                            <th class="w-2/5">担当タスク</th>
                                            <th class="w-auto"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="staff-list-open-late">
                                        <!-- スタッフ行はJSで描画 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- 閉店作業エリア -->
                <div id="content-close" class="hidden">
                    <section class="task-section mb-6 md:mb-8">
                        <div class="section-header flex justify-between items-center">
                            <h2 class="section-title">
                                社員・遅番
                            </h2>
                             <button onclick="autoAssignTasks('closing_employee', 'close')" class="add-button secondary-button">
                                自動割振り
                            </button>
                        </div>
                        <div class="section-content space-y-4">
                            <!-- スタッフ追加フォーム (カスタムモーダル) -->
                            <div class="flex space-x-2">
                                <button id="add-staff-button-closing_employee" 
                                        class="custom-select-button staff-select-button placeholder flex-grow" 
                                        onclick="openStaffSelect('closing_employee', 'employees')"
                                        data-placeholder="--- 社員を検索・選択 ---">
                                    <span>--- 社員を検索・選択 ---</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <button onclick="addStaff('closing_employee')" class="add-button">追加</button>
                            </div>
                            <div>
                                <table class="task-table">
                                   <thead>
                                        <tr>
                                            <th class="w-1/4">スタッフ名</th>
                                            <th class="w-1/6">開始</th>
                                            <th class="w-1/6">終了</th>
                                            <th class="w-2/5">担当タスク</th>
                                            <th class="w-auto"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="staff-list-close-employee">
                                        <!-- スタッフ行はJSで描画 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <section class="task-section mb-6 md:mb-8">
                        <div class="section-header flex justify-between items-center">
                            <h2 class="section-title">
                                アルバイト・遅番
                            </h2>
                             <button onclick="autoAssignTasks('closing_alba', 'close')" class="add-button secondary-button">
                                自動割振り
                            </button>
                        </div>
                        <div class="section-content space-y-4">
                            <!-- スタッフ追加フォーム (カスタムモーダル) -->
                            <div class="flex space-x-2">
                                <button id="add-staff-button-closing_alba" 
                                        class="custom-select-button staff-select-button placeholder flex-grow" 
                                        onclick="openStaffSelect('closing_alba', 'alba_late')"
                                        data-placeholder="--- 遅番アルバイトを検索・選択 ---">
                                    <span>--- 遅番アルバイトを検索・選択 ---</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <button onclick="addStaff('closing_alba')" class="add-button">追加</button>
                            </div>
                            <div>
                                <table class="task-table">
                                    <thead>
                                        <tr>
                                            <th class="w-1/4">スタッフ名</th>
                                            <th class="w-1/6">開始</th>
                                            <th class="w-1/6">終了</th>
                                            <th class="w-2/5">担当タスク</th>
                                            <th class="w-auto"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="staff-list-close-alba">
                                        <!-- スタッフ行はJSで描画 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
            
            <!-- 「割振り確認」タブのコンテンツ -->
            <div id="content-summary" class="hidden">
                <section class="mb-10">
                    <!-- 見出しとボタンをフレックスボックスで横並びに -->
                    <div class="flex justify-between items-center mb-5">
                        <h2 class="section-title" style="border-color: #4f46e5;">
                            開店作業 タイムライン
                        </h2>
                        <!-- CSVダウンロードボタンを追加 -->
                        <button onclick="exportTimelineCSV('open')" class="add-button text-sm py-2 px-3">
                            CSVダウンロード
                        </button>
                    </div>
                    <!-- タイムラインコンテナに変更 -->
                    <div id="summary-open-container" class="timeline-container">
                        <!-- タイムラインはJSで描画 -->
                    </div>
                </section>
                
                <section class="mb-10">
                     <!-- 見出しとボタンをフレックスボックスで横並びに -->
                    <div class="flex justify-between items-center mb-5">
                        <h2 class="section-title" style="border-color: #4f46e5;">
                            閉店作業 タイムライン
                        </h2>
                         <!-- CSVダウンロードボタンを追加 -->
                        <button onclick="exportTimelineCSV('close')" class="add-button text-sm py-2 px-3">
                            CSVダウンロード
                        </button>
                    </div>
                     <!-- タイムラインコンテナに変更 -->
                    <div id="summary-close-container" class="timeline-container">
                        <!-- タイムラインはJSで描画 -->
                    </div>
                </section>
            </div>
            
        </main>

    </div>

    <!-- 削除確認モーダル -->
    <div id="delete-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">削除の確認</h3>
            <p id="delete-modal-message" class="mb-6">本当に削除しますか？</p>
            <div class="flex justify-end space-x-3">
                <button onclick="cancelDelete()" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300 transition">
                    キャンセル
                </button>
                <button id="confirm-delete-button" onclick="confirmDelete()" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700 transition">
                    削除する
                </button>
            </div>
        </div>
    </div>
    
    <!-- カスタム選択モーダル (汎用) -->
    <div id="select-modal" class="select-modal-overlay hidden">
        <div class="select-modal-content">
            <h3 id="select-modal-title" class="select-modal-header"></h3>
            <div id="select-modal-body" class="select-modal-body">
                <!-- 選択肢はJSで描画 -->
            </div>
            <div class="select-modal-footer">
                <button onclick="closeSelectModal()" class="modal-close-button">閉じる</button>
            </div>
        </div>
    </div>


    <script>
        // --- 設定データ ---

        // スタッフのマスター名簿 (PDFから)
        const masterStaffList = {
            employees: [
                // "田村もも乃", "阿部 敏之", "西田在城", "佐藤 大輔", "古場 健悟", 
                // "川野 剛史", "浅野貴之", 
                "関口 周吾", "鈴木優希", "鈴木 達也", 
                "成田 健吾", "柳谷 圭亮", "石山峻冴", "小野坂隼", "若松脩斗", "生沼彪"
            ],
            alba_early: [
                "根岸 麻美", "五十嵐 由衣", "曲山 琴菜", "山北 桃香", "上地佑夏", 
                "中村 仁美", "砂川 愛香", "村上麻衣", "小林夏美", "高橋瑞穂", "細田 竜成"
            ],
            alba_late: [
                "富岡 千尋", "浅羽駿汰", "堀切綾", "大山 真菜", "金田 愛伽", 
                "梅津世那", "高橋 良維河", "立岩昭人"
            ]
        };

        // タスクリスト
        const taskLists = {
            open: [
                "金銭計数",
                "近隣店チェック・外販", // ★変更
                "空調、配電系",
                "抽選準備",
                "抽選",
                "台チェック",
                "販促確認",
                "朝礼" // ★変更
            ],
            close: [
                // "カード点滅つぶし（営業後できるだけ）", // ★削除
                "立駐2人",
                "事務所清掃",
                "島上クイックルワイパー",
                "引継ぎ記載",
                "施錠確認",
                "飲み残し",
                "工具箱チェック",
                // "（営業中）島下確認", // ★削除
                // "（営業中）30π手補給", // ★削除
                // "（営業中）カード点滅つぶし" // ★削除
            ]
        };
        
        // --- アプリケーション状態 ---

        // タスク割り振りデータ
        let staffList = {
            early: [],
            late: [],
            closing_employee: [],
            closing_alba: []
        };
        
        // 削除確認用の一時保存
        let deleteInfo = { type: null, sectionKey: null, staffIndex: null, taskIndex: null };
        
        // カスタム選択モーダルのための一時保存
        let currentSelect = {
            type: null, // 'staff', 'task', 'time'
            callback: null,
            buttonEl: null,
            currentValue: null
        };
        // スタッフ追加用の一時保存
        let staffToAdd = {
            early: null,
            late: null,
            closing_employee: null,
            closing_alba: null
        };

        // 時間スロットの事前生成
        const openTimeSlots = generateTimeSlots('07:00', '10:00', 15);
        const closeTimeSlots = generateTimeSlots('22:45', '23:30', 15);

        // --- アプリケーションロジック ---

        document.addEventListener('DOMContentLoaded', () => {
            updateStaffLists();
            
            // モーダル外クリックで閉じる
            document.getElementById('select-modal').addEventListener('click', (event) => {
                if (event.target === document.getElementById('select-modal')) {
                    closeSelectModal();
                }
            });
        });

        /**
         * メインのタブ（割振り/確認）を切り替えます。
         */
        function showTab(tabName) {
            const isAssign = tabName === 'assign';
            document.getElementById('content-assign').classList.toggle('hidden', !isAssign);
            document.getElementById('content-summary').classList.toggle('hidden', isAssign);
            document.getElementById('tab-assign').classList.toggle('active', isAssign);
            document.getElementById('tab-summary').classList.toggle('active', !isAssign);
            
            // 「割振り確認」タブが選ばれたら、サマリーを再生成
            if (tabName === 'summary') {
                generateSummaryView();
            }
        }
        
        /**
         * サブのタブ（開店/閉店）を切り替えます。
         */
        function showSubTab(tabName) {
            const isOpen = tabName === 'open';
            document.getElementById('content-open').classList.toggle('hidden', !isOpen);
            document.getElementById('content-close').classList.toggle('hidden', isOpen);
            document.getElementById('tab-open').classList.toggle('active', isOpen);
            document.getElementById('tab-close').classList.toggle('active', !isOpen);
        }
        
        // --- カスタム選択モーダル関連 ---
        
        /**
         * スタッフ選択モーダルを開きます。
         */
        function openStaffSelect(sectionKey, masterListKey) {
            const masterList = masterStaffList[masterListKey];
            const currentStaff = staffList[sectionKey].map(s => s.name);
            const selectedStaffName = staffToAdd[sectionKey];
            
            // 既にリストにいるスタッフを除外
            const options = masterList.filter(name => !currentStaff.includes(name));
            
            const modalBody = document.getElementById('select-modal-body');
            modalBody.innerHTML = ''; // クリア
            
            if (options.length === 0) {
                 modalBody.innerHTML = `<div class="p-4 text-center text-gray-500">追加できるスタッフがいません。</div>`;
            } else {
                options.forEach(name => {
                    const isSelected = name === selectedStaffName;
                    modalBody.innerHTML += `
                        <div class="select-modal-option ${isSelected ? 'selected' : ''}" 
                             onclick="selectStaff('${sectionKey}', '${name.replace(/'/g, "\\'")}')">
                            ${name}
                        </div>`;
                });
            }
            
            document.getElementById('select-modal-title').textContent = "スタッフを選択";
            document.getElementById('select-modal').classList.remove('hidden');
            
            // 選択状態を保存
            currentSelect = {
                type: 'staff',
                buttonEl: document.getElementById(`add-staff-button-${sectionKey}`),
                callback: (name) => selectStaff(sectionKey, name),
                currentValue: selectedStaffName
            };
        }

        /**
         * モーダルでスタッフを選択
         */
        function selectStaff(sectionKey, staffName) {
            staffToAdd[sectionKey] = staffName;
            
            // ボタンのテキストを更新
            const buttonEl = document.getElementById(`add-staff-button-${sectionKey}`);
            buttonEl.querySelector('span').textContent = staffName;
            buttonEl.classList.remove('placeholder');
            
            closeSelectModal();
        }

        /**
         * タスク選択モーダルを開きます。
         */
        function openTaskSelect(sectionKey, staffIndex, taskIndex, taskListName) {
            const tasks = taskLists[taskListName];
            const currentValue = staffList[sectionKey][staffIndex].tasks[taskIndex].task;
            
            const modalBody = document.getElementById('select-modal-body');
            modalBody.innerHTML = `<div class="select-modal-option clear-option" onclick="selectTask('', '--- タスクを選択 ---')">--- タスクを選択 ---</div>`; // クリアオプション
            
            tasks.forEach(task => {
                const isSelected = task === currentValue;
                modalBody.innerHTML += `
                    <div class="select-modal-option ${isSelected ? 'selected' : ''}" 
                         onclick="selectTask('${task.replace(/'/g, "\\'")}', '${task.replace(/'/g, "\\'")}')">
                        ${task}
                    </div>`;
            });
            
            document.getElementById('select-modal-title').textContent = "タスクを選択";
            document.getElementById('select-modal').classList.remove('hidden');
            
            // 選択状態を保存
            currentSelect = {
                type: 'task',
                buttonEl: document.getElementById(`task-btn-${sectionKey}-${staffIndex}-${taskIndex}`),
                callback: (value, text) => {
                    handleChange(sectionKey, staffIndex, taskIndex, 'task', value);
                    updateSelectButton(currentSelect.buttonEl, text, value === "");
                },
                currentValue: currentValue
            };
        }
        
        /**
         * 時間選択モーダルを開きます。
         */
        function openTimeSelect(sectionKey, staffIndex, taskIndex, field, timeSlotList) {
            const currentValue = staffList[sectionKey][staffIndex].tasks[taskIndex][field];
            
            const modalBody = document.getElementById('select-modal-body');
            modalBody.innerHTML = `<div class="select-modal-option clear-option" onclick="selectTime('--')">--</div>`; // クリアオプション
            
            timeSlotList.forEach(time => {
                const isSelected = time === currentValue;
                modalBody.innerHTML += `
                    <div class="select-modal-option ${isSelected ? 'selected' : ''}" 
                         onclick="selectTime('${time}')">
                        ${time}
                    </div>`;
            });
            
            const title = field === 'start' ? '開始時間を選択' : '終了時間を選択';
            document.getElementById('select-modal-title').textContent = title;
            document.getElementById('select-modal').classList.remove('hidden');
            
            // 選択状態を保存
            currentSelect = {
                type: 'time',
                buttonEl: document.getElementById(`${field}-btn-${sectionKey}-${staffIndex}-${taskIndex}`),
                callback: (value) => {
                    handleChange(sectionKey, staffIndex, taskIndex, field, value === '--' ? '' : value);
                    updateSelectButton(currentSelect.buttonEl, value, value === '--');
                },
                currentValue: currentValue
            };
        }
        
        /**
         * モーダルで選択肢を決定（タスク・時間共通）
         */
        function selectTask(value, text) {
            if (currentSelect.callback) {
                currentSelect.callback(value, text);
            }
            closeSelectModal();
        }
        
        function selectTime(value) {
            if (currentSelect.callback) {
                currentSelect.callback(value);
            }
            closeSelectModal();
        }

        /**
         * 選択モーダルを閉じます。
         */
        function closeSelectModal() {
            document.getElementById('select-modal').classList.add('hidden');
            currentSelect = { type: null, callback: null, buttonEl: null, currentValue: null };
        }
        
        /**
         * 選択ボタンの表示を更新
         */
        function updateSelectButton(buttonEl, text, isPlaceholder) {
            if (buttonEl) {
                buttonEl.querySelector('span').textContent = text;
                buttonEl.classList.toggle('placeholder', isPlaceholder);
            }
        }
        
        // --- スタッフ・タスク操作 ---

        /**
         * スタッフをリストに追加します。
         */
        function addStaff(sectionKey) {
            const staffName = staffToAdd[sectionKey];
            if (!staffName) return; // 名前が選択されていない

            // 既にリストにいるか最終チェック
            if (staffList[sectionKey].find(staff => staff.name === staffName)) {
                return;
            }

            staffList[sectionKey].push({
                name: staffName,
                tasks: [{ start: "", end: "", task: "" }]
            });
            
            // 追加フォームをリセット
            staffToAdd[sectionKey] = null;
            const buttonEl = document.getElementById(`add-staff-button-${sectionKey}`);
            updateSelectButton(buttonEl, buttonEl.getAttribute('data-placeholder'), true);

            updateStaffLists();
        }

        /**
         * 特定のスタッフにタスクを追加します。
         */
        function addTask(sectionKey, staffIndex) {
            staffList[sectionKey][staffIndex].tasks.push({ start: "", end: "", task: "" });
            updateStaffLists();
        }

        /**
         * 削除モーダルを表示します。
         */
        function showDeleteModal(type, sectionKey, staffIndex, taskIndex = null) {
            deleteInfo = { type, sectionKey, staffIndex, taskIndex };
            const modal = document.getElementById('delete-modal');
            const messageEl = document.getElementById('delete-modal-message');
            
            if (type === 'staff') {
                const staffName = staffList[sectionKey][staffIndex].name;
                messageEl.textContent = `「${staffName}」さんをリストから削除します。よろしいですか？`;
            } else { // type === 'task'
                messageEl.textContent = `このタスクを削除します。よろしいですか？`;
            }
            modal.classList.remove('hidden');
        }

        /**
         * 削除をキャンセルします。
         */
        function cancelDelete() {
            document.getElementById('delete-modal').classList.add('hidden');
            deleteInfo = { type: null, sectionKey: null, staffIndex: null, taskIndex: null };
        }

        /**
         * 削除を確定実行します。
         */
        function confirmDelete() {
            const { type, sectionKey, staffIndex, taskIndex } = deleteInfo;

            if (type === 'staff') {
                staffList[sectionKey].splice(staffIndex, 1);
            } else if (type === 'task') {
                // タスクが1つの場合は削除させない（代わりにスタッフを削除させる）
                if (staffList[sectionKey][staffIndex].tasks.length > 1) {
                    staffList[sectionKey][staffIndex].tasks.splice(taskIndex, 1);
                }
            }
            
            cancelDelete(); // モーダルを閉じる
            updateStaffLists(); // リストを再描画
        }

        /**
         * タスクや時間の変更をデータに保存します。
         */
        function handleChange(sectionKey, staffIndex, taskIndex, field, value) {
            try {
                staffList[sectionKey][staffIndex].tasks[taskIndex][field] = value;
            } catch (e) {
                console.error("Error updating data:", {sectionKey, staffIndex, taskIndex, field, value}, e);
            }
        }
        
        /**
         * タスクの自動割振り (★時間設定機能追加 + バグ修正)
         */
        function autoAssignTasks(sectionKey, taskListName) {
            const staffInGroup = staffList[sectionKey];
            const numStaff = staffInGroup.length;
            
            if (numStaff === 0) {
                // TODO: カスタムアラート
                console.warn("スタッフが追加されていません。");
                return;
            }
            
            const allTasks = [...taskLists[taskListName]];
            const pairTasks = allTasks.filter(t => t.includes('2人'));
            const singleTasks = allTasks.filter(t => !t.includes('2人'));
            
            // 1. 全スタッフのタスクをリセット
            staffInGroup.forEach(staff => staff.tasks = []);
            
            let staffIndex = 0;
            
            // 2. ペアタスクを割り当て
            for (const task of pairTasks) {
                if (staffIndex + 1 < numStaff) {
                    // ペアで割り当て可能
                    staffInGroup[staffIndex].tasks.push({ start: "", end: "", task: task });
                    staffInGroup[staffIndex + 1].tasks.push({ start: "", end: "", task: task });
                    staffIndex += 2;
                } else if (staffIndex < numStaff) {
                    // 1人しか残っていない
                    staffInGroup[staffIndex].tasks.push({ start: "", end: "", task: task });
                    console.warn(`ペアタスク '${task}' は1人に割り当てられました。`);
                    staffIndex++;
                }
                // スタッフが残っていない場合 (staffIndex >= numStaff)、タスクは割り当てられない
            }
            
            // 3. シングルタスクを全員にラウンドロビンで割り当て
            staffIndex = 0; // インデックスをリセット
            for (const task of singleTasks) {
                const staffToAssign = staffInGroup[staffIndex % numStaff];
                staffToAssign.tasks.push({ start: "", end: "", task: task });
                staffIndex++;
            }
            
            // 4. タスクが0個のスタッフがいないか確認 (UI表示のため)
            staffInGroup.forEach(staff => {
                if (staff.tasks.length === 0) {
                    staff.tasks.push({ start: "", end: "", task: "" });
                }
            });
            
            // 5. 時間を割り振る (★修正箇所)
            const timeSlots = (taskListName === 'open') ? openTimeSlots : closeTimeSlots;
            if (timeSlots.length > 1) { // 少なくとも2スロット(1タスク分)必要
                staffInGroup.forEach(staff => {
                    let nextStartTimeIndex = 0;
                    staff.tasks.forEach(task => {
                        // ★修正1: まだ時間が設定されておらず(ペアタスクなどで)、かつ割り当て可能な時間スロットがある場合
                        if (!task.start && nextStartTimeIndex < timeSlots.length - 1) { 
                            // ★修正2: 最後のスロットは開始時間として使わない
                            
                            const startTime = timeSlots[nextStartTimeIndex];
                            const endTime = timeSlots[nextStartTimeIndex + 1]; // 15分後のスロット
                            
                            task.start = startTime;
                            task.end = endTime;
                            
                            // ペアタスクの場合は、ペアの相手も同じ時間にする
                            if (task.task.includes('2人')) {
                                const pairStaff = staffInGroup.find(s => 
                                    s.name !== staff.name && 
                                    s.tasks.some(t => t.task === task.task && !t.start) // まだ時間が設定されてないペアを探す
                                );
                                if (pairStaff) {
                                    const pairTask = pairStaff.tasks.find(t => t.task === task.task && !t.start);
                                    if (pairTask) {
                                        pairTask.start = startTime;
                                        pairTask.end = endTime;
                                    }
                                }
                            }
                            
                            nextStartTimeIndex++; // 次のタスクは次の時間へ
                        }
                    });
                });
            }
            
            updateStaffLists();
        }


        /**
         * 全てのスタッフリストのHTMLを再描画します。
         */
        function updateStaffLists() {
            populateStaffList('staff-list-open-early', 'early', 'open', openTimeSlots);
            populateStaffList('staff-list-open-late', 'late', 'open', openTimeSlots);
            populateStaffList('staff-list-close-employee', 'closing_employee', 'close', closeTimeSlots);
            populateStaffList('staff-list-close-alba', 'closing_alba', 'close', closeTimeSlots);
        }

        /**
         * スタッフリストとタスク選択プルダウンを生成して配置します。
         * カスタムプルダウン(ボタン)に変更
         */
        function populateStaffList(containerId, sectionKey, taskListName, timeSlots) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = ''; // コンテナをクリア
            
            const timeSlotJSON = JSON.stringify(timeSlots); // onclick用にJSON文字列化

            // staffListから該当セクションのスタッフを描画
            staffList[sectionKey].forEach((staff, staffIndex) => {
                
                let staffHtml = '';
                const staffName = staff.name.replace(/'/g, "\\'"); // 'エスケープ

                staff.tasks.forEach((task, taskIndex) => {
                    
                    const startBtnText = task.start || '--';
                    const startBtnClass = task.start ? '' : 'placeholder';
                    const endBtnText = task.end || '--';
                    const endBtnClass = task.end ? '' : 'placeholder';
                    const taskBtnText = task.task || '--- タスクを選択 ---';
                    const taskBtnClass = task.task ? '' : 'placeholder';
                    
                    const btnBaseId = `${sectionKey}-${staffIndex}-${taskIndex}`;

                    if (taskIndex === 0) {
                        // 1行目 (スタッフ名 + 最初のタスク)
                        staffHtml += `
                            <tr class="staff-row">
                                <!-- スタッフ名 -->
                                <td class="staff-name-cell" data-label="スタッフ名">
                                    <div class="flex items-center justify-between">
                                        <span>${staff.name}</span>
                                        <button onclick="showDeleteModal('staff', '${sectionKey}', ${staffIndex})" 
                                                class="remove-button" 
                                                title="${staffName} さんを削除">&times;</button>
                                    </div>
                                </td>
                                <!-- 1行目のタスク -->
                                <td data-label="開始">
                                    <button id="start-btn-${btnBaseId}" class="custom-select-button ${startBtnClass}" 
                                            onclick="openTimeSelect('${sectionKey}', ${staffIndex}, ${taskIndex}, 'start', ${timeSlotJSON})">
                                        <span>${startBtnText}</span>
                                    </button>
                                </td>
                                <td data-label="終了">
                                    <button id="end-btn-${btnBaseId}" class="custom-select-button ${endBtnClass}" 
                                            onclick="openTimeSelect('${sectionKey}', ${staffIndex}, ${taskIndex}, 'end', ${timeSlotJSON})">
                                        <span>${endBtnText}</span>
                                    </button>
                                </td>
                                <td data-label="担当タスク">
                                    <button id="task-btn-${btnBaseId}" class="custom-select-button ${taskBtnClass}" 
                                            onclick="openTaskSelect('${sectionKey}', ${staffIndex}, ${taskIndex}, '${taskListName}')">
                                        <span>${taskBtnText}</span>
                                    </button>
                                </td>
                                <td class="task-buttons-cell">
                                    <!-- 1行目でもタスク削除ボタンを配置 (タスクが2個以上の場合のみ) -->
                                    ${staff.tasks.length > 1 ? 
                                        `<button onclick="showDeleteModal('task', '${sectionKey}', ${staffIndex}, ${taskIndex})" 
                                                 class="remove-task-button" 
                                                 title="このタスクを削除">－</button>` : 
                                        `<button onclick="addTask('${sectionKey}', ${staffIndex})" 
                                                 class="add-task-button" 
                                                 title="タスクを追加">+</button>`
                                    }
                                </td>
                            </tr>`;
                    } else {
                        // 2行目以降のタスク
                        staffHtml += `
                            <tr class="task-row">
                                <td class="task-label">
                                    <button onclick="addTask('${sectionKey}', ${staffIndex})" 
                                            class="add-task-button" 
                                            title="タスクを追加">+ タスク追加</button>
                                </td>
                                <td data-label="開始">
                                    <button id="start-btn-${btnBaseId}" class="custom-select-button ${startBtnClass}" 
                                            onclick="openTimeSelect('${sectionKey}', ${staffIndex}, ${taskIndex}, 'start', ${timeSlotJSON})">
                                        <span>${startBtnText}</span>
                                    </button>
                                </td>
                                <td data-label="終了">
                                    <button id="end-btn-${btnBaseId}" class="custom-select-button ${endBtnClass}" 
                                            onclick="openTimeSelect('${sectionKey}', ${staffIndex}, ${taskIndex}, 'end', ${timeSlotJSON})">
                                        <span>${endBtnText}</span>
                                    </button>
                                </td>
                                <td data-label="担当タスク">
                                    <button id="task-btn-${btnBaseId}" class="custom-select-button ${taskBtnClass}" 
                                            onclick="openTaskSelect('${sectionKey}', ${staffIndex}, ${taskIndex}, '${taskListName}')">
                                        <span>${taskBtnText}</span>
                                    </button>
                                </td>
                                <td class="task-buttons-cell">
                                    <button onclick="showDeleteModal('task', '${sectionKey}', ${staffIndex}, ${taskIndex})" 
                                            class="remove-task-button" 
                                            title="このタスクを削除">－</button>
                                </td>
                            </tr>`;
                    }
                });
                
                // スマホ用に、タスクが1つの場合の「+」ボタンは1行目に含めるように変更
                
                container.innerHTML += staffHtml;
            });
        }
        
        // --- サマリー表示関数群 (タイムライン版) ---
        
        /**
         * 「割振り確認」タブのタイムラインを生成・表示
         */
        function generateSummaryView() {
            // 開店作業
            const openTasks = [
                ...collectTasks(staffList.early),
                ...collectTasks(staffList.late)
            ];
            const openStaff = [
                ...new Set([...staffList.early.map(s => s.name), ...staffList.late.map(s => s.name)])
            ].sort();
            const openHtml = createTimelineTable(openTasks, openStaff, openTimeSlots);
            document.getElementById('summary-open-container').innerHTML = openHtml;
            
            // 閉店作業
            const closeTasks = [
                ...collectTasks(staffList.closing_employee),
                ...collectTasks(staffList.closing_alba)
            ];
             const closeStaff = [
                ...new Set([...staffList.closing_employee.map(s => s.name), ...staffList.closing_alba.map(s => s.name)])
            ].sort();
            const closeHtml = createTimelineTable(closeTasks, closeStaff, closeTimeSlots);
            document.getElementById('summary-close-container').innerHTML = closeHtml;
        }
        
        /**
         * staffListからタスクをフラットな配列に変換
         */
        function collectTasks(staffGroup) {
            let allTasks = [];
            staffGroup.forEach(staff => {
                staff.tasks.forEach(task => {
                    if (task.task) { // タスク名があるもののみ
                        allTasks.push({
                            name: staff.name,
                            ...task
                        });
                    }
                });
            });
            return allTasks;
        }

        /**
         * タイムラインのHTMLテーブルを生成
         */
        function createTimelineTable(tasks, staffNames, timeSlots) {
            if (staffNames.length === 0) {
                return '<p class="p-4 text-center text-gray-500">割り当てられたスタッフがいません。</p>';
            }
            
            // 1. ヘッダー行 (時間)
            let headerHtml = '<tr><th>スタッフ</th>';
            timeSlots.forEach(time => {
                headerHtml += `<th>${time}</th>`;
            });
            headerHtml += '</tr>';
            
            // 2. ボディ行 (スタッフごと)
            let bodyHtml = '';
            staffNames.forEach(name => {
                bodyHtml += `<tr><th>${name}</th>`;
                
                const staffTasks = tasks
                    .filter(t => t.name === name && t.start) // startがあるタスクのみ
                    .sort((a, b) => a.start.localeCompare(b.start)); // 開始時間でソート

                let timeSlotIndex = 0;
                while (timeSlotIndex < timeSlots.length) {
                    const currentTime = timeSlots[timeSlotIndex];
                    
                    // この時間から始まるタスクを探す
                    const task = staffTasks.find(t => t.start === currentTime);
                    
                    if (task && task.end) {
                        // 終了時間があるタスク
                        const startIndex = timeSlotIndex;
                        const endIndex = timeSlots.indexOf(task.end);
                        
                        let colspan = 1;
                        if (endIndex > startIndex) {
                            colspan = endIndex - startIndex; // 07:00-07:15ならcolspan=1
                        }
                        // 終了時間がスロットにない場合
                        if (endIndex === -1) {
                             colspan = 1;
                             console.warn("終了時間がスロットと一致しません:", task);
                        }
                        
                        // ペアタスクか判定
                        const isPair = task.task.includes('2人');
                        const pairClass = isPair ? 'pair-task' : '';
                        
                        bodyHtml += `<td colspan="${colspan}">
                                        <div class="task-bar ${pairClass}" title="${task.task} (${task.start}-${task.end})">
                                            ${task.task}
                                        </div>
                                     </td>`;
                        timeSlotIndex += colspan; // インデックスをジャンプ
                        
                    } else if (task && !task.end) {
                        // 終了時間がないタスク
                        const isPair = task.task.includes('2人');
                        const pairClass = isPair ? 'pair-task' : '';
                        
                         bodyHtml += `<td>
                                        <div class="task-bar ${pairClass}" title="${task.task} (${task.start}-?)">
                                            ${task.task}
                                        </div>
                                     </td>`;
                        timeSlotIndex++;
                        
                    } else {
                        // タスクがない空きスロット
                        bodyHtml += '<td></td>';
                        timeSlotIndex++;
                    }
                }
                
                bodyHtml += '</tr>';
            });

            return `
                <table class="timeline-table">
                    <thead>${headerHtml}</thead>
                    <tbody>${bodyHtml}</tbody>
                </table>
            `;
        }
        
        // --- CSVエクスポート関数群 ---

        /**
         * タイムラインをCSVとしてエクスポートするトリガー
         */
        function exportTimelineCSV(type) {
            let tasks, staffNames, timeSlots, fileName;
            
            if (type === 'open') {
                tasks = [
                    ...collectTasks(staffList.early),
                    ...collectTasks(staffList.late)
                ];
                staffNames = [
                    ...new Set([...staffList.early.map(s => s.name), ...staffList.late.map(s => s.name)])
                ].sort();
                timeSlots = openTimeSlots;
                fileName = 'kaigyou_timeline.csv';
            } else { // type === 'close'
                tasks = [
                    ...collectTasks(staffList.closing_employee),
                    ...collectTasks(staffList.closing_alba)
                ];
                staffNames = [
                    ...new Set([...staffList.closing_employee.map(s => s.name), ...staffList.closing_alba.map(s => s.name)])
                ].sort();
                timeSlots = closeTimeSlots;
                fileName = 'heigyou_timeline.csv';
            }
            
            if (staffNames.length === 0) {
                // 将来的にカスタムアラートに変更
                console.warn("エクスポートするデータがありません。");
                return;
            }
            
            const csvContent = generateTimelineCSV(tasks, staffNames, timeSlots);
            downloadCSV(csvContent, fileName);
        }

        /**
         * タイムラインデータからCSV文字列を生成
         */
        function generateTimelineCSV(tasks, staffNames, timeSlots) {
            let csv = '';
            
            // ヘッダー行 (時間)
            // 引用符で囲み、カンマエスケープ
            const header = ['"スタッフ"', ...timeSlots.map(t => `"${t}"`)].join(',');
            csv += header + '\r\n';
            
            // データ行 (スタッフごと)
            staffNames.forEach(name => {
                let row = [`"${name.replace(/"/g, '""')}"`]; // 1列目はスタッフ名
                
                const staffTasks = tasks
                    .filter(t => t.name === name && t.start) // startがあるタスクのみ
                    .sort((a, b) => a.start.localeCompare(b.start));

                // CSVではcolspanが使えないので、各セルにタスクを埋める
                let taskMap = new Array(timeSlots.length).fill(null);
                
                staffTasks.forEach(task => {
                    const startIndex = timeSlots.indexOf(task.start);
                    if (startIndex === -1) return; // 開始時間がない

                    const endIndex = timeSlots.indexOf(task.end);
                    const end = (endIndex > startIndex) ? endIndex : (startIndex + 1); // 終了未定か1スロットなら1つ分

                    const taskName = (task.task || 'タスク未入力')
                                        .replace(/\r\n|\n|\r/g, " ")
                                        .replace(/"/g, '""');
                    const taskLabel = `"${taskName} (${task.start}-${task.end || '?'})"`;

                    // タスクでセルを埋める
                    for (let i = startIndex; i < end && i < timeSlots.length; i++) {
                        taskMap[i] = taskLabel;
                    }
                });
                
                // nullを空セル "" に変換
                const cells = taskMap.map(cell => cell || '""');
                
                row.push(...cells); // スタッフ名の配列にタイムスロットの配列を結合
                csv += row.join(',') + '\r\n'; // 1行分のCSV文字列を追加
            });
            
            return csv;
        }

        /**
         * CSVコンテンツをファイルとしてダウンロード
         */
        function downloadCSV(csvContent, fileName) {
            // 日本語（UTF-8）のCSVがExcelで文字化けするのを防ぐBOMを付与
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
            
            const link = document.createElement("a");
            if (link.download !== undefined) { // ブラウザがdownload属性をサポートしているか
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url); // メモリ解放
            }
        }
        
        // --- (ここまで追加) ---


        /**
         * 指定された時間範囲と間隔で時間スロットの配列を生成します。
         */
        function generateTimeSlots(startTime, endTime, intervalMinutes) {
            const slots = [];
            let [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);

            let currentMinutes = startHour * 60 + startMin;
            const endTotalMinutes = endHour * 60 + endMin;

            while (currentMinutes <= endTotalMinutes) {
                const hour = Math.floor(currentMinutes / 60);
                const minute = currentMinutes % 60;
                
                slots.push(
                    `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`
                );
                
                currentMinutes += intervalMinutes;
            }
            return slots;
        }

    </script>
</body>
</html>

