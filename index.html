<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>開閉店タスク割り振りBOT</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- ★★★ Firebase SDK（認証機能なし・DBのみ）★★★ -->
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // ★ 認証(Auth)ライブラリを「完全に」削除しました
        import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase 初期化 ---

        // ▼▼▼▼▼ お客様の設定（wakatest-46f14）に設定済みです ▼▼▼▼▼
        const firebaseConfig = {
          apiKey: "AIzaSyBdjf2YJIo9OSJhPDBuEJAxqjVvS0qTN3E",
          authDomain: "wakatest-46f14.firebaseapp.com",
          projectId: "wakatest-46f14",
          storageBucket: "wakatest-46f14.firebasestorage.app",
          messagingSenderId: "770004156053",
          appId: "1:770004156053:web:04645f8fa745b07c03659c"
        };
        const appId = "wakatest-46f14"; 
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        let app, db;
        let unsubscribeFromTasks; // onSnapshotのリスナー解除用
        let taskDocRef; // Firestoreのドキュメント参照

        /**
         * Firebaseの初期化とデータ監視を開始
         */
        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                setLogLevel('Debug'); // デバッグログを有効化

                // Firestoreのパスを定義
                taskDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'task_assignments', 'today');

                // ★ 認証ロジックをすべて削除
                
                // ★ すぐにデータ監視を開始
                startTaskListener();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                const header = document.querySelector('header');
                if(header) {
                    header.innerHTML += `<p class="text-red-500 font-bold">データベース接続エラー: ${error.message}</p>`;
                }
            }
        }

        /**
         * Firestoreのタスク割り当てデータの監視を開始
         */
        function startTaskListener() {
            if (unsubscribeFromTasks) {
                unsubscribeFromTasks();
            }
            console.log("Starting Firestore snapshot listener for:", taskDocRef.path);
            
            // onSnapshotでリアルタイムのデータ変更を監視
            unsubscribeFromTasks = onSnapshot(taskDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    console.log("Firestore data received:", docSnap.data());
                    const data = docSnap.data();
                    window.staffList.early = data.early || [];
                    window.staffList.late = data.late || [];
                    window.staffList.closing_employee = data.closing_employee || [];
                    window.staffList.closing_alba = data.closing_alba || [];
                } else {
                    console.log("No data found in Firestore. Using default empty list.");
                    window.staffList = { early: [], late: [], closing_employee: [], closing_alba: [] };
                }
                
                // ★データ受信時に「編集リスト」と「タイムライン」の両方を更新
                // （現在アクティブなモードに基づいて描画関数を呼ぶ）
                window.refreshCurrentView();


            }, (error) => {
                console.error("Error listening to Firestore:", error);
            });
        }

        /**
         * データをFirestoreに保存 (★パスワードチェックはHTML側で行う)
         */
        async function saveStaffListToFirestore() {
            // ★isEditing (パスワード入力済み) でなければ保存しない
            if (!window.isEditing) {
                console.warn("Not in editing mode. Save blocked.");
                return;
            }
            
            if (!taskDocRef) {
                console.error("Firestore document reference is not initialized.");
                return;
            }

            try {
                console.log("Saving data to Firestore...", window.staffList);
                const cleanData = JSON.parse(JSON.stringify(window.staffList));
                await setDoc(taskDocRef, cleanData);
                console.log("Data saved successfully.");
            } catch (error) {
                console.error("Error saving data to Firestore:", error);
            }
        }

        // --- グローバルスコープに関数を公開 ---
        window.initFirebase = initFirebase;
        window.saveStaffListToFirestore = saveStaffListToFirestore;
    </script>
    <!-- ★★★ Firebase SDK (ここまで) ★★★ -->

    <style>
        /* モダンデザインのスタイル */
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f4f7fa; 
            color: #334155; 
        }

        h1.title-effect {
            font-size: 2.5rem; /* 4xl (36px) */
            font-weight: 700;
            color: #1e293b; /* Gray-800 (黒っぽい色) */
        }
        @media (min-width: 768px) {
             h1.title-effect {
                font-size: 3rem; /* 5xl (48px) */
             }
        }

        /* タブ (セグメントコントロール風) */
        .tab-container {
            background-color: #e2e8f0; /* Gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.25rem;
            display: flex;
            width: fit-content;
        }
        .tab-button {
            transition: all 0.3s ease;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500;
            color: #475569; /* Gray-600 */
            border: 2px solid transparent;
            font-size: 0.875rem; /* text-sm */
            padding: 0.5rem 1rem;
            white-space: nowrap; /* ★追加 */
        }
        .tab-button.active {
            background-color: #ffffff;
            color: #3b82f6; /* Blue-500 */
            font-weight: 600;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
         @media (min-width: 768px) {
            .tab-button {
                font-size: 1rem; /* text-base */
                padding: 0.75rem 1.5rem;
            }
         }
         
        /* サブタブ (開店・閉店) */
        .sub-tab-button {
             font-size: 0.875rem; /* text-sm */
             padding: 0.5rem 1rem;
        }


        /* セクション (カード風) */
        .task-section {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid #e2e8f0; /* Gray-200 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            overflow: hidden; /* テーブルの角丸のため */
        }
        
        .section-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0; /* Gray-200 */
            background-color: #f8fafc; /* Gray-50 */
        }

        .section-title {
            color: #1e293b; /* Gray-800 */
            font-weight: 600;
            font-size: 1.25rem; /* xl */
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        
        .section-content {
            padding: 1rem;
        }
         @media (min-width: 768px) {
             .section-content {
                padding: 1.5rem;
            }
         }

        /* ボタン共通 (インディゴ) */
        .add-button {
            background-color: #4f46e5; /* Indigo-600 */
            color: #ffffff;
            padding: 0.625rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.15s ease-in-out, box-shadow 0.15s ease;
            white-space: nowrap;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .add-button:hover {
            background-color: #4338ca; /* Indigo-700 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        /* 自動割振り・管理者ボタン (セカンダリ) */
        .secondary-button {
            background-color: #f1f5f9; /* Gray-100 */
            color: #475569; /* Gray-600 */
            border: 1px solid #cbd5e1; /* Gray-300 */
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
         .secondary-button:hover {
            background-color: #e2e8f0; /* Gray-200 */
            box-shadow: none;
         }


        .remove-button {
            background-color: transparent;
            color: #dc2626; /* Red-600 */
            border: 1px solid #ef4444; /* Red-500 */
            border-radius: 9999px; /* rounded-full */
            width: 26px;
            height: 26px;
            font-size: 1.125rem;
            line-height: 1.25;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease-in-out;
            padding-bottom: 2px; /* for &times; centering */
        }
        .remove-button:hover {
            background-color: #dc2626;
            color: #ffffff;
        }
        .remove-task-button {
            width: 22px;
            height: 22px;
            font-size: 1rem;
            color: #64748b; /* Gray-500 */
            border: 1px solid #94a3b8; /* Gray-400 */
            border-radius: 9999px;
        }
         .remove-task-button:hover {
            background-color: #64748b;
            color: #ffffff;
         }
        .add-task-button {
            background-color: #f1f5f9; /* Gray-100 */
            color: #475569; /* Gray-600 */
            border: 1px solid #cbd5e1; /* Gray-300 */
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
        }
        .add-task-button:hover {
            background-color: #e2e8f0; /* Gray-200 */
        }

        /* Table styles (クリーン) */
        .task-table {
            width: 100%;
            border-collapse: collapse; /* ★collapse */
        }

        .task-table th,
        .task-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* Gray-200 */
            vertical-align: middle;
        }
        
        .task-table th {
            font-weight: 600;
            color: #475569; /* Gray-600 */
            text-transform: uppercase;
            font-size: 0.75rem; /* xs */
            letter-spacing: 0.05em;
            background-color: #f8fafc; /* Gray-50 */
        }
        
        /* スタッフ行のスタイル */
        .staff-row td {
            /* 最初のタスク行と同じ */
        }
        /* タスク行のスタイル */
        .task-row td {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px dashed #e2e8f0; /* Gray-200 */
        }
        .task-row:last-child td {
             border-bottom: 1px solid #e2e8f0; /* 最後のタスク行 */
        }
        .task-label {
            text-align: right;
            font-size: 0.875rem;
            color: #64748b;
            padding-right: 0.5rem;
            vertical-align: top;
            padding-top: 0.75rem;
        }
        .staff-name-cell {
            font-weight: 500;
            color: #1e293b;
            font-size: 1.125rem; /* lg */
        }
        
        /* カスタムプルダウン (スマホ対応) */
        .custom-select-button {
            width: 100%;
            text-align: left;
            padding: 0.5rem 0.75rem;
            border: 1px solid #cbd5e1; /* Gray-300 */
            border-radius: 0.375rem;
            background-color: #ffffff;
            min-height: 38px; /* inputの高さと合わせる */
            font-size: 0.875rem; /* text-sm */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* スタッフ追加ボタンのデザイン */
        .staff-select-button {
            padding: 0.625rem 0.75rem; /* 10px 12px */
            min-height: 42px; /* add-buttonと高さを合わせる */
        }
        .staff-select-button.placeholder {
            color: #64748b; /* Gray-500 */
        }
        
        .custom-select-button.placeholder {
            color: #94a3b8; /* Gray-400 */
        }
        .custom-select-button:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .custom-select-button svg {
            width: 1.25rem;
            height: 1.25rem;
            color: #94a3b8;
        }

        /* カスタムモーダル (選択肢用) */
        .select-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        .select-modal-content {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .select-modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
        }
        .select-modal-body {
            overflow-y: auto;
            padding: 0.5rem;
        }
        .select-modal-option {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            border-radius: 0.375rem;
            transition: background-color 0.15s ease-in-out;
            font-size: 1rem;
        }
        .select-modal-option:hover {
            background-color: #f1f5f9; /* Gray-100 */
        }
        .select-modal-option.selected {
            background-color: #dbeafe; /* Blue-100 */
            color: #1d4ed8; /* Blue-700 */
            font-weight: 500;
        }
         .select-modal-option.clear-option {
            color: #64748b;
            font-style: italic;
         }
        .select-modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e2e8f0;
            text-align: right;
        }
        .modal-close-button {
            background-color: #4f46e5; /* Indigo-600 */
            color: #ffffff;
            padding: 0.5rem 1.25rem;
            border-radius: 0.375rem;
            font-weight: 500;
        }
         .modal-close-button:hover {
            background-color: #4338ca;
         }

        
        /* 削除確認・ログインモーダル (共通) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(15, 23, 42, 0.5); /* Slate-900 with 50% opacity */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 400px;
            width: 90%;
        }
        
        /* タイムライン（割振り確認）用スタイル */
        .timeline-container {
            width: 100%;
            overflow-x: auto; /* スマホ用に横スクロール */
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        .timeline-table {
            width: 100%;
            min-width: 1000px; /* 横スクロールを強制 */
            border-collapse: collapse;
        }
        .timeline-table th,
        .timeline-table td {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            height: 3.5rem; /* 高さを固定 */
            text-align: left;
            vertical-align: top;
            font-size: 0.875rem;
        }
        .timeline-table thead th {
            background-color: #f8fafc;
            text-align: center;
            vertical-align: middle;
            font-weight: 600;
            color: #475569;
            min-width: 100px; /* 時間セルの最小幅 */
            white-space: nowrap;
        }
        .timeline-table tbody th { /* スタッフ名セル */
            background-color: #f8fafc;
            font-weight: 600;
            color: #1e293b;
            min-width: 150px;
            white-space: nowrap;
            position: sticky; /* ★スタッフ名をスクロール追従 */
            left: 0;
            z-index: 10;
        }
        .timeline-table tbody td {
            position: relative;
        }
        /* タスクバーのスタイル (インディゴ) */
        .task-bar {
            position: absolute;
            top: 4px;
            left: 2px;
            right: 2px;
            bottom: 4px;
            background-color: #c7d2fe; /* Indigo-200 */
            border: 1px solid #818cf8; /* Indigo-400 */
            color: #3730a3; /* Indigo-800 */
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            z-index: 1;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        /* ペアタスクは色を変える */
        .task-bar.pair-task {
            background-color: #fecaca; /* Red-200 */
            border-color: #f87171; /* Red-400 */
            color: #991b1b; /* Red-800 */
        }
        /* ★ 朝礼タスクの色 (緑) */
        .task-bar.briefing-task {
            background-color: #d1fae5; /* Green-100 */
            border-color: #6ee7b7; /* Green-300 */
            color: #065f46; /* Green-800 */
        }
        /* ★ 金銭計数タスクの色 (黄) */
        .task-bar.money-task {
            background-color: #fef9c3; /* Yellow-100 */
            border-color: #fde047; /* Yellow-300 */
            color: #854d0e; /* Yellow-800 */
        }
         /* ★ 個人業務タスクの色 (グレー) */
        .task-bar.free-task {
            background-color: #f1f5f9; /* Gray-100 */
            border-color: #cbd5e1; /* Gray-300 */
            color: #475569; /* Gray-600 */
            font-style: italic;
        }
        /* ★ 立駐タスクの色 (青) */
        .task-bar.parking-task {
            background-color: #dbeafe; /* Blue-100 */
            border-color: #93c5fd; /* Blue-300 */
            color: #1e40af; /* Blue-800 */
        }
        /* ★ 閉店社員タスクの色 (紫) */
        .task-bar.lock-task,
        .task-bar.toolbox-task,
        .task-bar.handoff-task {
            background-color: #e9d5ff; /* Purple-100 */
            border-color: #c084fc; /* Purple-300 */
            color: #581c87; /* Purple-800 */
        }


        /* レスポンシブ (スマホ用) */
        @media (max-width: 767px) {
            /* ★「編集モード」ボタンを中央タブの下に移動 */
            .edit-button-container {
                position: static;
                transform: none;
                margin-top: 0.75rem; /* 12px */
                justify-content: center;
                display: flex;
            }
            .main-tab-container {
                flex-direction: column;
                align-items: center;
            }

            .task-table {
                display: block;
                width: 100%;
            }
            .task-table thead {
                display: none; /* テーブルヘッダー非表示 */
            }
            .task-table tbody, .task-table tr, .task-table td {
                display: block;
                width: 100% !important; /* !importantで幅指定を上書き */
                padding: 0;
                border: 0;
            }
            
            .task-table tr {
                border-bottom: 1px solid #e2e8f0;
                margin-bottom: 1.5rem;
                padding-bottom: 1rem;
            }
            .task-table tr:last-child {
                margin-bottom: 0;
                padding-bottom: 0;
                border-bottom: 0;
            }

            .task-table td {
                padding: 0.5rem 0.25rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            /* TDにラベルを追加 */
            .task-table td:before {
                content: attr(data-label);
                font-weight: 600;
                color: #64748b; /* Gray-500 */
                padding-right: 1rem;
                white-space: nowrap;
            }
            
            .staff-name-cell {
                padding: 0.5rem 0.25rem 1rem 0.25rem; /* 名前だけパディング大きめ */
                font-size: 1.25rem;
            }
            .staff-name-cell:before {
                display: none; /* 名前セルはラベル不要 */
            }
            
            .task-label {
                display: none; /* 元のタスクラベルは非表示 */
            }
            
            /* スマホ用のボタン配置 */
            .task-buttons-cell {
                justify-content: space-around; /* ボタンを均等配置 */
                padding-top: 0.5rem;
            }
             .task-buttons-cell:before {
                display: none; /* ラベル不要 */
             }
            
            .remove-button {
                width: 32px;
                height: 32px;
                font-size: 1.25rem;
            }
            .add-task-button, .remove-task-button {
                width: 30px;
                height: 30px;
                font-size: 1.25rem;
                padding: 0;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }

        }

    </style>
</head>
<body class="p-4 md:p-8 lg:p-10">

    <div class="max-w-7xl mx-auto">

        <!-- ヘッダー -->
        <header class="text-center mb-8">
            <h1 class="title-effect tracking-wide">
                開閉店タスク割り振りBOT
            </h1>
        </header>
        
        <!-- ★★★ メインコントロール ★★★ -->
        <div class="mb-6 md:mb-8 flex flex-col md:flex-row justify-center items-center relative main-tab-container">
            <!-- 開店・閉店タブ (閲覧・編集 共通) -->
            <div id="sub-tab-container" class="tab-container">
                <button id="tab-open" class="tab-button sub-tab-button active" onclick="showSubTab('open')">
                    開店作業 (早番)
                </button>
                <button id="tab-close" class="tab-button sub-tab-button" onclick="showSubTab('close')">
                    閉店作業 (遅番)
                </button>
            </div>
            
            <!-- ★ パスワードボタン -->
            <div class="edit-button-container md:absolute md:right-0 md:top-1/2 md:-translate-y-1/2">
                <button id="edit-mode-button" class="add-button secondary-button" onclick="showPasswordModal()">
                    管理者編集
                </button>
            </div>
        </div>


        <!-- メインコンテンツ -->
        <main>
            
            <!-- ★★★ 編集モード専用コンテナ (デフォルトは非表示) ★★★ -->
            <div id="edit-mode-container" class="hidden">
                <!-- --- 開店作業エリア (編集用) --- -->
                <div id="edit-content-open" class="space-y-6 md:space-y-8">
                    <!-- カード型セクション (社員・早番) -->
                    <section class="task-section mb-6 md:mb-8">
                        <div class="section-header flex justify-between items-center">
                            <h2 class="section-title">
                                社員・早番 (編集)
                            </h2>
                            <button onclick="autoAssignTasks('early', 'open')" class="add-button secondary-button">
                                自動割振り
                            </button>
                        </div>
                        <div class="section-content space-y-4">
                            <!-- スタッフ追加フォーム -->
                            <div class="flex space-x-2">
                                <button id="add-staff-button-early" 
                                        class="custom-select-button staff-select-button placeholder flex-grow" 
                                        onclick="openStaffSelect('early', 'employees')"
                                        data-placeholder="--- 社員を検索・選択 ---">
                                    <span>--- 社員を検索・選択 ---</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <button onclick="addStaff('early')" class="add-button">追加</button>
                            </div>
                            <!-- スタッフ一覧テーブル -->
                            <div>
                                <table class="task-table">
                                    <thead>
                                        <tr>
                                            <th class="w-1/4">スタッフ名</th>
                                            <th class="w-1/6">開始</th>
                                            <th class="w-1/6">終了</th>
                                            <th class="w-2/5">担当タスク</th>
                                            <th class="w-auto"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="staff-list-open-early">
                                        <!-- スタッフ行はJSで描画 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <!-- カード型セクション (早番アルバイト) -->
                    <section class="task-section mb-6 md:mb-8">
                        <div class="section-header flex justify-between items-center">
                            <h2 class="section-title">
                                早番アルバイト (編集)
                            </h2>
                            <button onclick="autoAssignTasks('late', 'open')" class="add-button secondary-button">
                                自動割振り
                            </button>
                        </div>
                        <div class="section-content space-y-4">
                            <!-- スタッフ追加フォーム -->
                            <div class="flex space-x-2">
                                <button id="add-staff-button-late" 
                                        class="custom-select-button staff-select-button placeholder flex-grow" 
                                        onclick="openStaffSelect('late', 'alba_early')"
                                        data-placeholder="--- 早番アルバイトを検索・選択 ---">
                                    <span>--- 早番アルバイトを検索・選択 ---</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <button onclick="addStaff('late')" class="add-button">追加</button>
                            </div>
                            <div>
                                <table class="task-table">
                                    <thead>
                                        <tr>
                                            <th class="w-1/4">スタッフ名</th>
                                            <th class="w-1/6">開始</th>
                                            <th class="w-1/6">終了</th>
                                            <th class="w-2/5">担当タスク</th>
                                            <th class="w-auto"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="staff-list-open-late">
                                        <!-- スタッフ行はJSで描画 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- --- 閉店作業エリア (編集用) --- -->
                <div id="edit-content-close" class="space-y-6 md:space-y-8 hidden">
                    <!-- カード型セクション (社員・遅番) -->
                    <section class="task-section mb-6 md:mb-8">
                        <div class="section-header flex justify-between items-center">
                            <h2 class="section-title">
                                社員・遅番 (編集)
                            </h2>
                             <button onclick="autoAssignTasks('closing_employee', 'close')" class="add-button secondary-button">
                                自動割振り
                            </button>
                        </div>
                        <div class="section-content space-y-4">
                            <!-- スタッフ追加フォーム -->
                            <div class="flex space-x-2">
                                <button id="add-staff-button-closing_employee" 
                                        class="custom-select-button staff-select-button placeholder flex-grow" 
                                        onclick="openStaffSelect('closing_employee', 'employees')"
                                        data-placeholder="--- 社員を検索・選択 ---">
                                    <span>--- 社員を検索・選択 ---</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <button onclick="addStaff('closing_employee')" class="add-button">追加</button>
                            </div>
                            <div>
                                <table class="task-table">
                                    <thead>
                                        <tr>
                                            <th class="w-1/4">スタッフ名</th>
                                            <th class="w-1/6">開始</th>
                                            <th class="w-1/6">終了</th>
                                            <th class="w-2/5">担当タスク</th>
                                            <th class="w-auto"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="staff-list-close-employee">
                                        <!-- スタッフ行はJSで描画 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <!-- カード型セクション (アルバイト・遅番) -->
                    <section class="task-section mb-6 md:mb-8">
                        <div class="section-header flex justify-between items-center">
                            <h2 class="section-title">
                                アルバイト・遅番 (編集)
                            </h2>
                             <button onclick="autoAssignTasks('closing_alba', 'close')" class="add-button secondary-button">
                                自動割振り
                            </button>
                        </div>
                        <div class="section-content space-y-4">
                            <!-- スタッフ追加フォーム -->
                            <div class="flex space-x-2">
                                <button id="add-staff-button-closing_alba" 
                                        class="custom-select-button staff-select-button placeholder flex-grow" 
                                        onclick="openStaffSelect('closing_alba', 'alba_late')"
                                        data-placeholder="--- 遅番アルバイトを検索・選択 ---">
                                    <span>--- 遅番アルバイトを検索・選択 ---</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <button onclick="addStaff('closing_alba')" class="add-button">追加</button>
                            </div>
                            <div>
                                <table class="task-table">
                                    <thead>
                                        <tr>
                                            <th class="w-1/4">スタッフ名</th>
                                            <th class="w-1/6">開始</th>
                                            <th class="w-1/6">終了</th>
                                            <th class="w-2/5">担当タスク</th>
                                            <th class="w-auto"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="staff-list-close-alba">
                                        <!-- スタッフ行はJSで描画 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
            
            <!-- ★★★ 閲覧モード専用コンテナ (デフォルトで表示) ★★★ -->
            <div id="view-mode-container" class="">
                 <!-- --- 開店作業エリア (閲覧用) --- -->
                <div id="view-content-open">
                    <!-- 開店作業 タイムライン -->
                    <section class="mb-10">
                        <div class="flex justify-between items-center mb-5">
                            <h2 class="section-title" style="border-color: #4f46e5;">
                                開店作業 タイムライン
                            </h2>
                        </div>
                        <div id="summary-open-container">
                            <!-- PC用 (横スクロール) -->
                            <div id="summary-open-container-desktop" class="timeline-container hidden md:block">
                                <!-- PC用タイムラインはJSで描画 -->
                            </div>
                            <!-- スマホ用 (縦リスト) -->
                            <div id="summary-open-container-mobile" class="md:hidden">
                                <!-- スマホ用リストはJSで描画 -->
                            </div>
                        </div>
                    </section>
                </div>
                
                <!-- --- 閉店作業エリア (閲覧用) --- -->
                <div id="view-content-close" class="hidden">
                    <!-- 閉店作業 タイムライン -->
                    <section class="mb-10">
                        <div class="flex justify-between items-center mb-5">
                            <h2 class="section-title" style="border-color: #4f46e5;">
                                閉店作業 タイムライン
                            </h2>
                        </div>
                         <div id="summary-close-container">
                            <!-- PC用 (横スクロール) -->
                            <div id="summary-close-container-desktop" class="timeline-container hidden md:block">
                                <!-- PC用タイムラインはJSで描画 -->
                            </div>
                            <!-- スマホ用 (縦リスト) -->
                            <div id="summary-close-container-mobile" class="md:hidden">
                                <!-- スマホ用リストはJSで描画 -->
                            </div>
                         </div>
                    </section>
                </div>
            </div>

        </main>

    </div>

    <!-- ★★★ パスワードモーダル ★★★ -->
    <div id="password-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">管理者パスワード</h3>
            <p class="mb-4">編集するにはパスワードを入力してください。</p>
            <input id="password-input" type="password" class="w-full p-2 border border-gray-300 rounded-md mb-2" placeholder="パスワード">
            <p id="password-error" class="text-red-500 text-sm mb-4 hidden">パスワードが違います。</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closePasswordModal()" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300 transition">
                    キャンセル
                </button>
                <button onclick="checkPassword()" class="px-4 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 transition">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- 削除確認モーダル -->
    <div id="delete-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">削除の確認</h3>
            <p id="delete-modal-message" class="mb-6">本当に削除しますか？</p>
            <div class="flex justify-end space-x-3">
                <button onclick="cancelDelete()" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300 transition">
                    キャンセル
                </button>
                <button id="confirm-delete-button" onclick="confirmDelete()" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700 transition">
                    削除する
                </button>
            </div>
        </div>
    </div>
    
    <!-- カスタム選択モーダル (汎用) -->
    <div id="select-modal" class="select-modal-overlay hidden">
        <div class="select-modal-content">
            <h3 id="select-modal-title" class="select-modal-header"></h3>
            <div id="select-modal-body" class="select-modal-body">
                <!-- 選択肢はJSで描画 -->
            </div>
            <div class="select-modal-footer">
                <button onclick="closeSelectModal()" class="modal-close-button">閉じる</button>
            </div>
        </div>
    </div>


    <script>
        // --- 設定データ ---
        const masterStaffList = {
            employees: [
                "関口 周吾", "鈴木優希", "鈴木 達也", 
                "成田 健吾", "柳谷 圭亮", "石山峻冴", "小野坂隼", "若松脩斗", "生沼彪"
            ],
            alba_early: [
                "根岸 麻美", "五十嵐 由衣", "曲山 琴菜", "山北 桃香", "上地佑夏", 
                "中村 仁美", "砂川 愛香", "村上麻衣", "小林夏美", "高橋瑞穂", "細田 竜成"
            ],
            alba_late: [
                "富岡 千尋", "浅羽駿汰", "堀切綾", "大山 真菜", "金田 愛伽", 
                "梅津世那", "高橋 良維河", "立岩昭人"
            ]
        };

        // ★★★ タスクリスト (強化版) ★★★
        const taskLists = {
            open: [
                // "金銭計数", // ★特別タスク (社員のみ)
                "近隣店チェック・外販",
                "空調、配電系",
                "抽選準備",
                "抽選",
                "台チェック",
                "販促確認",
                // "朝礼" // ★特別タスク (早番全員)
            ],
            close: [
                // "立駐2人", // ★特別タスク (各グループ1人)
                "事務所清掃",
                "島上クイックルワイパー",
                // "引継ぎ記載", // ★特別タスク (社員のみ)
                // "施錠確認", // ★特別タスク (社員のみ)
                "飲み残し",
                // "工具箱チェック", // ★特別タスク (社員のみ)
            ]
        };
        // ★ 特別なタスクの定義
        const SPECIAL_TASKS = {
            BRIEFING: "朝礼",
            MONEY_COUNT: "金銭計数",
            FREE_TASK: "自由、個人業務",
            PARKING: "立駐2人", // ★変更なし
            LOCK_CHECK: "施錠確認", // ★変更なし
            TOOLBOX_CHECK: "工具箱チェック", // ★変更なし
            HANDOFF: "引継ぎ記載" // ★追加
        };
        
        // --- アプリケーション状態 ---

        // ★ 編集モード状態 (パスワード入力済みか)
        window.isEditing = false;
        const EDIT_PASSWORD = "admin"; // ★ パスワード

        // ★タスク割り振りデータ (グローバルスコープ)
        window.staffList = {
            early: [],
            late: [],
            closing_employee: [],
            closing_alba: []
        };
        
        let deleteInfo = { type: null, sectionKey: null, staffIndex: null, taskIndex: null };
        
        let currentSelect = {
            type: null, // 'staff', 'task', 'time'
            callback: null,
            buttonEl: null,
            currentValue: null
        };
        
        let staffToAdd = {
            early: null,
            late: null,
            closing_employee: null,
            closing_alba: null
        };

        const openTimeSlots = generateTimeSlots('07:00', '10:00', 15);
        const closeTimeSlots = generateTimeSlots('22:45', '23:30', 15);
        
        // --- アプリケーションロジック ---

        document.addEventListener('DOMContentLoaded', () => {
            // ★ Firebaseの初期化を実行
            if (window.initFirebase) {
                window.initFirebase();
            }
            
            // ★UI初期設定関数を呼ぶ
            setupInitialView();
            
            // モーダル外クリックで閉じる
            document.getElementById('select-modal').addEventListener('click', (event) => {
                if (event.target === document.getElementById('select-modal')) {
                    closeSelectModal();
                }
            });
            
            // ★ パスワードモーダルでEnterキーを押したときの処理
            document.getElementById('password-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });
        });
        
        
        /**
         * ★ データ受信時（onSnapshot）またはモード切替時にビューを更新
         */
        window.refreshCurrentView = function() {
            // ★ 編集リスト（テーブル）とタイムライン（サマリー）の両方を常にデータ更新
            window.updateStaffLists();
            window.generateSummaryView();
            
            // ★ 現在のタブ状態に基づいて、表示/非表示を切り替える
            const isOpen = document.getElementById('tab-open').classList.contains('active');
            showSubTab(isOpen ? 'open' : 'close');
        }


        /**
         * ★ページ読み込み時のUI初期状態を設定 (パスワード版)
         */
        function setupInitialView() {
            // ★ 編集モードをオフに (閲覧モードで開始)
            setEditingMode(false);
            
            // ★デフォルトは「開店」タブを表示
            showSubTab('open');
            
            // ★リストとサマリーの両方を描画
            // (onSnapshotが呼ばれるとデータがロードされ、リストとサマリーが自動更新される)
            updateStaffLists();
            generateSummaryView();
        }

        /**
         * ★ サブのタブ（開店/閉店）を切り替えます (閲覧/編集 両対応)
         */
        function showSubTab(tabName) {
            const isOpen = tabName === 'open';
            
            // --- 編集モードのUI ---
            document.getElementById('edit-content-open').classList.toggle('hidden', !isOpen);
            document.getElementById('edit-content-close').classList.toggle('hidden', isOpen);
            
            // --- 閲覧モードのUI ---
            document.getElementById('view-content-open').classList.toggle('hidden', !isOpen);
            document.getElementById('view-content-close').classList.toggle('hidden', isOpen);
            
            // --- タブボタンの active 状態 ---
            document.getElementById('tab-open').classList.toggle('active', isOpen);
            document.getElementById('tab-close').classList.toggle('active', !isOpen);
        }
        
        // ★★★ パスワード（編集モード）関連の関数 ★★★

        /**
         * パスワードモーダルを表示
         */
        function showPasswordModal() {
            // ★ 既に編集モードの場合は、編集モードをオフにする
            if (window.isEditing) {
                setEditingMode(false);
                return;
            }
            // ★ 閲覧モードの場合は、パスワードモーダルを開く
            document.getElementById('password-modal').classList.remove('hidden');
            document.getElementById('password-input').value = ""; // 入力欄クリア
            document.getElementById('password-error').classList.add('hidden'); // エラー非表示
            document.getElementById('password-input').focus();
        }

        /**
         * パスワードモーダルを閉じる
         */
        function closePasswordModal() {
            document.getElementById('password-modal').classList.add('hidden');
        }

        /**
         * パスワードをチェック
         */
        function checkPassword() {
            const input = document.getElementById('password-input').value;
            const errorEl = document.getElementById('password-error');
            
            if (input === EDIT_PASSWORD) {
                // 認証成功
                closePasswordModal();
                setEditingMode(true); // ★ 編集モードをオン
            } else {
                // 認証失敗
                errorEl.classList.remove('hidden');
            }
        }
        
        /**
         * 編集モードのオン/オフを切り替え
         */
        function setEditingMode(isEditing) {
            window.isEditing = isEditing;
            
            // ★ 閲覧モード と 編集モード のコンテナを切り替え
            document.getElementById('view-mode-container').classList.toggle('hidden', isEditing);
            document.getElementById('edit-mode-container').classList.toggle('hidden', !isEditing);
            
            const editButton = document.getElementById('edit-mode-button');
            if (isEditing) {
                editButton.textContent = "閲覧モードに戻る";
                editButton.classList.remove('secondary-button'); // 通常ボタンの色に戻す
            } else {
                editButton.textContent = "管理者編集";
                editButton.classList.add('secondary-button');
            }
        }
        
        // --- カスタム選択モーダル関連 ---
        
        function openStaffSelect(sectionKey, masterListKey) {
            // ★ 編集モードガード (念のため)
            if (!window.isEditing) return;
            
            const masterList = masterStaffList[masterListKey]; 
            const currentStaff = window.staffList[sectionKey].map(s => s.name);
            const selectedStaffName = staffToAdd[sectionKey];
            const options = masterList.filter(name => !currentStaff.includes(name));
            
            const modalBody = document.getElementById('select-modal-body');
            modalBody.innerHTML = ''; 
            
            if (options.length === 0) {
                 modalBody.innerHTML = `<div class="p-4 text-center text-gray-500">追加できるスタッフがいません。</div>`;
            } else {
                 options.forEach(name => {
                     const isSelected = name === selectedStaffName;
                     modalBody.innerHTML += `
                         <div class="select-modal-option ${isSelected ? 'selected' : ''}" 
                              onclick="selectStaff('${sectionKey}', '${name.replace(/'/g, "\\'")}')">
                             ${name}
                         </div>`;
                 });
            }
            
            document.getElementById('select-modal-title').textContent = "スタッフを選択";
            document.getElementById('select-modal').classList.remove('hidden');
            
            currentSelect = {
                type: 'staff',
                buttonEl: document.getElementById(`add-staff-button-${sectionKey}`),
                callback: (name) => selectStaff(sectionKey, name),
                currentValue: selectedStaffName
            };
        }

        function selectStaff(sectionKey, staffName) {
            staffToAdd[sectionKey] = staffName;
            const buttonEl = document.getElementById(`add-staff-button-${sectionKey}`);
            buttonEl.querySelector('span').textContent = staffName;
            buttonEl.classList.remove('placeholder');
            closeSelectModal();
        }

        function openTaskSelect(sectionKey, staffIndex, taskIndex, taskListName) {
            if (!window.isEditing) return;
            
            // ★ 「朝礼」などは手動選択リストに表示しない
            let tasks = [...taskLists[taskListName]]; 
            
            // ★ 手動で「自由、個人業務」も選べるようにする
            if (!tasks.includes(SPECIAL_TASKS.FREE_TASK)) {
                tasks.push(SPECIAL_TASKS.FREE_TASK);
            }
            
            const currentValue = window.staffList[sectionKey][staffIndex].tasks[taskIndex].task;
            
            const modalBody = document.getElementById('select-modal-body');
            modalBody.innerHTML = `<div class="select-modal-option clear-option" onclick="selectTask('', '--- タスクを選択 ---')">--- タスクを選択 ---</div>`; 
            
            tasks.forEach(task => {
                const isSelected = task === currentValue;
                modalBody.innerHTML += `
                    <div class="select-modal-option ${isSelected ? 'selected' : ''}" 
                         onclick="selectTask('${task.replace(/'/g, "\\'")}', '${task.replace(/'/g, "\\'")}')">
                        ${task}
                    </div>`;
            });
            
            document.getElementById('select-modal-title').textContent = "タスクを選択";
            document.getElementById('select-modal').classList.remove('hidden');
            
            currentSelect = {
                type: 'task',
                buttonEl: document.getElementById(`task-btn-${sectionKey}-${staffIndex}-${taskIndex}`),
                callback: (value, text) => {
                    handleChange(sectionKey, staffIndex, taskIndex, 'task', value);
                    updateSelectButton(currentSelect.buttonEl, text, value === "");
                },
                currentValue: currentValue
            };
        }
        
        function openTimeSelect(sectionKey, staffIndex, taskIndex, field, timeSlotList) {
            if (!window.isEditing) return;
            const currentValue = window.staffList[sectionKey][staffIndex].tasks[taskIndex][field];
            
            const modalBody = document.getElementById('select-modal-body');
            modalBody.innerHTML = `<div class="select-modal-option clear-option" onclick="selectTime('--')">--</div>`; 
            
            timeSlotList.forEach(time => {
                const isSelected = time === currentValue;
                modalBody.innerHTML += `
                    <div class="select-modal-option ${isSelected ? 'selected' : ''}" 
                         onclick="selectTime('${time}')">
                        ${time}
                    </div>`;
            });
            
            const title = field === 'start' ? '開始時間を選択' : '終了時間を選択';
            document.getElementById('select-modal-title').textContent = title;
            document.getElementById('select-modal').classList.remove('hidden');
            
            currentSelect = {
                type: 'time',
                buttonEl: document.getElementById(`${field}-btn-${sectionKey}-${staffIndex}-${taskIndex}`),
                callback: (value) => {
                    handleChange(sectionKey, staffIndex, taskIndex, field, value === '--' ? '' : value);
                    updateSelectButton(currentSelect.buttonEl, value, value === '--');
                },
                currentValue: currentValue
            };
        }
        
        function selectTask(value, text) {
            if (currentSelect.callback) {
                currentSelect.callback(value, text);
            }
            closeSelectModal();
        }
        
        function selectTime(value) {
            if (currentSelect.callback) {
                currentSelect.callback(value);
            }
            closeSelectModal();
        }

        function closeSelectModal() {
            document.getElementById('select-modal').classList.add('hidden');
            currentSelect = { type: null, callback: null, buttonEl: null, currentValue: null };
        }
        
        function updateSelectButton(buttonEl, text, isPlaceholder) {
            if (buttonEl) {
                buttonEl.querySelector('span').textContent = text;
                buttonEl.classList.toggle('placeholder', isPlaceholder);
            }
        }
        
        // --- スタッフ・タスク操作 (編集モードのUIからのみ呼ばれる) ---

        function addStaff(sectionKey) {
            const staffName = staffToAdd[sectionKey];
            if (!staffName) return; 

            if (window.staffList[sectionKey].find(staff => staff.name === staffName)) {
                return;
            }

            window.staffList[sectionKey].push({
                name: staffName,
                tasks: [{ start: "", end: "", task: "" }]
            });
            
            staffToAdd[sectionKey] = null;
            const buttonEl = document.getElementById(`add-staff-button-${sectionKey}`);
            updateSelectButton(buttonEl, buttonEl.getAttribute('data-placeholder'), true);

            updateStaffLists();
            window.saveStaffListToFirestore();
        }

        function addTask(sectionKey, staffIndex) {
            window.staffList[sectionKey][staffIndex].tasks.push({ start: "", end: "", task: "" });
            updateStaffLists();
            window.saveStaffListToFirestore();
        }

        function showDeleteModal(type, sectionKey, staffIndex, taskIndex = null) {
            deleteInfo = { type, sectionKey, staffIndex, taskIndex };
            const modal = document.getElementById('delete-modal');
            const messageEl = document.getElementById('delete-modal-message');
            
            if (type === 'staff') {
                const staffName = window.staffList[sectionKey][staffIndex].name;
                messageEl.textContent = `「${staffName}」さんをリストから削除します。よろしいですか？`;
            } else { // type === 'task'
                messageEl.textContent = `このタスクを削除します。よろしいですか？`;
            }
            modal.classList.remove('hidden');
        }

        function cancelDelete() {
            document.getElementById('delete-modal').classList.add('hidden');
            deleteInfo = { type: null, sectionKey: null, staffIndex: null, taskIndex: null };
        }

        function confirmDelete() {
            const { type, sectionKey, staffIndex, taskIndex } = deleteInfo;

            if (type === 'staff') {
                window.staffList[sectionKey].splice(staffIndex, 1);
            } else if (type === 'task') {
                if (window.staffList[sectionKey][staffIndex].tasks.length > 1) {
                    window.staffList[sectionKey][staffIndex].tasks.splice(taskIndex, 1);
                }
            }
            
            cancelDelete(); // モーダルを閉じる
            updateStaffLists(); // リストを再描画
            window.saveStaffListToFirestore();
        }

        function handleChange(sectionKey, staffIndex, taskIndex, field, value) {
            try {
                window.staffList[sectionKey][staffIndex].tasks[taskIndex][field] = value;
                window.saveStaffListToFirestore(); 
            } catch (e) {
                console.error("Error updating data:", {sectionKey, staffIndex, taskIndex, field, value}, e);
            }
        }
        
        // ★★★ 自動割振り (強化版) ★★★
        function autoAssignTasks(sectionKey, taskListName) {
            const staffInGroup = window.staffList[sectionKey];
            if (staffInGroup.length === 0) {
                console.warn("スタッフが追加されていません。");
                return;
            }

            // 1. タスクリストの準備
            const availableTasks = [...taskLists[taskListName]];
            const pairTasks = availableTasks.filter(t => t.includes('2人'));
            let singleTasks = availableTasks.filter(t => !t.includes('2人'));

            // 2. 特殊タスクの準備とタイムスロットのフィルタリング
            let moneyTaskNeeded = false;
            let briefingTaskNeeded = false;
            let timeSlots = [];
            let timeSlotsStartIndex = 0;
            const fullTimeSlots = (taskListName === 'open') ? openTimeSlots : closeTimeSlots; // e.g., 07:00 - 10:00 (13 slots)

            // 3. スタッフのタスクをリセット
            staffInGroup.forEach(staff => staff.tasks = []);
            
            // 4. 各スタッフの次の空き時間インデックスを追跡
            let staffNextSlotIndices = new Array(staffInGroup.length).fill(0);


            if (taskListName === 'open') {
                // 「金銭計数」は 'early' (社員) グループのみ
                if (sectionKey === 'early') {
                    moneyTaskNeeded = true;
                }
                // 「朝礼」は 'early' と 'late' (早番) グループのみ
                if (sectionKey === 'early' || sectionKey === 'late') {
                    briefingTaskNeeded = true;
                }
                
                // 朝礼 (09:00-09:15) のインデックスを探す
                const briefingStartIndex = fullTimeSlots.indexOf('09:00'); // 8
                const briefingEndIndex = fullTimeSlots.indexOf('09:15'); // 9

                if (briefingStartIndex !== -1 && briefingEndIndex !== -1) {
                    // ★★★ 修正: 'late' (早番アルバイト) は 9時以降のみ
                    if (sectionKey === 'early') {
                        // 社員は 07:00 から
                        timeSlots = fullTimeSlots.slice(0, briefingStartIndex); // 07:00 - 08:45 (index 0-7)
                        timeSlots = timeSlots.concat(fullTimeSlots.slice(briefingEndIndex)); // 09:15 - 10:00 (index 9-12)
                        // timeSlots (early) = 12 slots total (index 0-11)
                    } else if (sectionKey === 'late') {
                        // 早番アルバイトは 09:15 から (朝礼 09:00-09:15 は別で入る)
                        timeSlots = fullTimeSlots.slice(briefingEndIndex); // 09:15 - 10:00 (index 9-12)
                        // timeSlots (late) = 4 slots total (index 0-3)
                    }
                } else {
                     // 朝礼スロットが見つからない場合 (フォールバック)
                    if (sectionKey === 'late') {
                        // ★ 9時より前のスロットを除外
                        const nineAmIndex = fullTimeSlots.indexOf('09:00');
                        if (nineAmIndex !== -1) {
                            timeSlots = fullTimeSlots.slice(nineAmIndex);
                        } else {
                            timeSlots = [...fullTimeSlots]; // フォールバック
                        }
                    } else {
                         timeSlots = [...fullTimeSlots];
                    }
                }

                // 4b. 固定タスクの割り当て (朝礼)
                if (briefingTaskNeeded) {
                    staffInGroup.forEach(staff => {
                        staff.tasks.push({ 
                            start: "09:00", 
                            end: "09:15", 
                            task: SPECIAL_TASKS.BRIEFING 
                        });
                    });
                }
                
                // 5. 特殊タスクの割り当て (金銭計数)
                // (sectionKey === 'early' の場合のみ moneyTaskNeeded = true)
                if (moneyTaskNeeded && staffInGroup.length > 0) {
                    const staff = staffInGroup[0];
                    const startTime = timeSlots[timeSlotsStartIndex]; // '07:00' (index 0)
                    // ★ 修正: 30分 (2スロット) 確保
                    const endTime = timeSlots[timeSlotsStartIndex + 2]; // '07:30' (index 2)
                    
                    if(startTime && endTime) { // ★ endTime (index 2) が存在するかチェック
                        staff.tasks.push({ 
                            start: startTime, 
                            end: endTime, 
                            task: SPECIAL_TASKS.MONEY_COUNT 
                        });
                        staffNextSlotIndices[0] += 2; // ★ 最初のスタッフのスロットを2つ進める
                        timeSlotsStartIndex += 2; // ★ 次のタスク開始インデックスを2つ進める
                    } else if (startTime && timeSlots[timeSlotsStartIndex + 1]) {
                        // ★ フォールバック: 30分枠が取れないが15分枠なら取れる場合 (例: 08:45)
                        const fallbackEndTime = timeSlots[timeSlotsStartIndex + 1];
                         staff.tasks.push({ 
                            start: startTime, 
                            end: fallbackEndTime, 
                            task: SPECIAL_TASKS.MONEY_COUNT 
                        });
                        staffNextSlotIndices[0]++;
                        timeSlotsStartIndex++;
                    }
                }
                
            } else { // 閉店作業
                timeSlots = [...fullTimeSlots]; // 22:45 - 23:30 (4 slots, index 0-3)

                // ★ 閉店用の特別タスクを準備
                let specialTasksQueue = [];
                // 1. 立駐は全員 (各グループ1人ずつ)
                specialTasksQueue.push(SPECIAL_TASKS.PARKING);
                
                // 2. 施錠と工具箱は社員のみ
                if (sectionKey === 'closing_employee') {
                    specialTasksQueue.push(SPECIAL_TASKS.LOCK_CHECK);
                    specialTasksQueue.push(SPECIAL_TASKS.TOOLBOX_CHECK);
                    specialTasksQueue.push(SPECIAL_TASKS.HANDOFF); // ★引継ぎ記載を追加
                }

                // 5. 特別タスクを割り当て (ラウンドロビン)
                let staffIndex = 0;
                for (const task of specialTasksQueue) {
                    const currentStaffIndex = staffIndex % staffInGroup.length;
                    const staff = staffInGroup[currentStaffIndex];
                    
                    const slotIndex = staffNextSlotIndices[currentStaffIndex];
                    
                    const startTime = timeSlots[slotIndex];
                    const endTime = timeSlots[slotIndex + 1];

                    if (startTime && endTime) {
                        staff.tasks.push({ start: startTime, end: endTime, task: task });
                        staffNextSlotIndices[currentStaffIndex]++; // このスタッフの次の空き時間を更新
                    }
                    
                    staffIndex++;
                }
                
                // ★ 閉店のペアタスク/シングルタスク用に staffIndex をリセット
                timeSlotsStartIndex = 0; // 閉店は0から
            }


            // 6. ペアタスクの割り当て
            for (const task of pairTasks) {
                // Find two staff with the minimum slot index
                let indices = [...staffNextSlotIndices.keys()].sort((a, b) => staffNextSlotIndices[a] - staffNextSlotIndices[b]);
                
                if (indices.length < 2) {
                    // Not enough staff for pairs, assign as single
                    const staff1 = (indices.length > 0) ? staffInGroup[indices[0]] : staffInGroup[0];
                    if (staff1) {
                        const slotIndex = (indices.length > 0) ? staffNextSlotIndices[indices[0]] : 0;
                        const startTime = timeSlots[slotIndex];
                        const endTime = timeSlots[slotIndex + 1];
                        if (startTime && endTime) {
                            staff1.tasks.push({ start: startTime, end: endTime, task: task });
                            if(indices.length > 0) staffNextSlotIndices[indices[0]]++;
                        }
                    }
                } else {
                    const staff1 = staffInGroup[indices[0]];
                    const staff2 = staffInGroup[indices[1]];
                    // Assign task at the later of the two start times
                    const slotIndex = Math.max(staffNextSlotIndices[indices[0]], staffNextSlotIndices[indices[1]]);
                    const startTime = timeSlots[slotIndex];
                    const endTime = timeSlots[slotIndex + 1];
                    
                    if (startTime && endTime) {
                        staff1.tasks.push({ start: startTime, end: endTime, task: task });
                        staff2.tasks.push({ start: startTime, end: endTime, task: task });
                        staffNextSlotIndices[indices[0]] = slotIndex + 1;
                        staffNextSlotIndices[indices[1]] = slotIndex + 1;
                    }
                }
            }


            // 7. シングルタスクの割り当て (ラウンドロビン)
            let staffIndex = 0;
            for (const task of singleTasks) {
                // 最小のスロットインデックスを持つスタッフを探す
                let minSlotIndex = Infinity;
                let targetStaffIndex = 0;
                
                // staffIndexから順番に探す
                for(let i=0; i<staffInGroup.length; i++) {
                     let realIndex = (staffIndex + i) % staffInGroup.length;
                     if (staffNextSlotIndices[realIndex] < minSlotIndex) {
                         minSlotIndex = staffNextSlotIndices[realIndex];
                         targetStaffIndex = realIndex;
                     }
                }

                const staff = staffInGroup[targetStaffIndex];
                const slotIndex = staffNextSlotIndices[targetStaffIndex];
                
                const startTime = timeSlots[slotIndex];
                const endTime = timeSlots[slotIndex + 1];

                if (startTime && endTime) {
                    staff.tasks.push({ start: startTime, end: endTime, task: task });
                    staffNextSlotIndices[targetStaffIndex]++; // このスタッフの次の空き時間を更新
                }
                
                staffIndex++; // 次のタスクは、(論理的に)次のスタッフから探し始める
            }
            
            // 8. 残り時間を「自由、個人業務」で埋める (★ 修正: 連続するスロットをまとめる)
            staffInGroup.forEach((staff, index) => {
                let firstFreeSlotIndex = staffNextSlotIndices[index];

                if (taskListName === 'open') {
                    
                    if (sectionKey === 'early') {
                        // `timeSlots` (early) = index 0-7 ('07:00'...'08:45') + index 8-11 ('09:15'...'10:00')
                        const gapIndex = 8; // '09:15' のインデックス

                        // 1. 朝礼前の空きを埋める
                        if (firstFreeSlotIndex < gapIndex) { // '07:00' - '08:45' の間に空きがある
                            if (firstFreeSlotIndex < gapIndex -1) { // 0-6 (開始スロット)
                                 staff.tasks.push({
                                    start: timeSlots[firstFreeSlotIndex], // 空き開始時間
                                    end: timeSlots[gapIndex - 1], // '08:45' (index 7)
                                    task: SPECIAL_TASKS.FREE_TASK
                                });
                            } else if (firstFreeSlotIndex === gapIndex - 1) { // 7
                                // 最後のスロット (08:45) だけが空いている場合
                                 staff.tasks.push({
                                    start: timeSlots[firstFreeSlotIndex], // 08:45
                                    end: fullTimeSlots[briefingStartIndex], // 09:00
                                    task: SPECIAL_TASKS.FREE_TASK
                                });
                            }
                            // 朝礼後の空きは 09:15 (index 8) から
                            firstFreeSlotIndex = gapIndex;
                        }
                        
                        // 2. 朝礼後の空きを埋める
                        if (firstFreeSlotIndex < timeSlots.length) { // 8-11
                            if (firstFreeSlotIndex < timeSlots.length - 1) { // 8-10 (開始スロット)
                                staff.tasks.push({
                                    start: timeSlots[firstFreeSlotIndex], // '09:15' 以降の空き開始時間
                                    end: timeSlots[timeSlots.length - 1], // '10:00' (index 11)
                                    task: SPECIAL_TASKS.FREE_TASK
                                });
                            } else if (firstFreeSlotIndex === timeSlots.length - 1) { // 11
                                // 最後のスロット (09:45) だけが空いている場合
                                 staff.tasks.push({
                                    start: timeSlots[firstFreeSlotIndex], // 09:45
                                    end: fullTimeSlots[fullTimeSlots.length - 1], // 10:00
                                    task: SPECIAL_TASKS.FREE_TASK
                                });
                            }
                        }
                    
                    } else if (sectionKey === 'late') {
                         // `timeSlots` (late) = index 0-3 ('09:15'...'10:00'). 4 slots.
                         if (firstFreeSlotIndex < timeSlots.length) {
                             if (firstFreeSlotIndex < timeSlots.length - 1) { // 0-2 (開始スロット)
                                staff.tasks.push({
                                    start: timeSlots[firstFreeSlotIndex],
                                    end: timeSlots[timeSlots.length - 1], // '10:00' (index 3)
                                    task: SPECIAL_TASKS.FREE_TASK
                                });
                            } else if (firstFreeSlotIndex === timeSlots.length - 1) { // 3
                                // 最後のスロット (09:45) だけが空いている場合
                                staff.tasks.push({
                                    start: timeSlots[firstFreeSlotIndex], // 09:45
                                    end: fullTimeSlots[fullTimeSlots.length - 1], // 10:00
                                    task: SPECIAL_TASKS.FREE_TASK
                                });
                            }
                        }
                    }

                } else { // 閉店作業の場合 (ギャップなし)
                    // `timeSlots` (close) = index 0-3 ('22:45'...'23:30')
                    if (firstFreeSlotIndex < timeSlots.length) {
                        if (firstFreeSlotIndex < timeSlots.length - 1) { // 0-2 (開始スロット)
                            staff.tasks.push({
                                start: timeSlots[firstFreeSlotIndex],
                                end: timeSlots[timeSlots.length - 1], // '23:30' (index 3)
                                task: SPECIAL_TASKS.FREE_TASK
                            });
                        } else if (firstFreeSlotIndex === timeSlots.length - 1) { // 3
                            // 最後のスロット (23:15) だけが空いている場合
                             staff.tasks.push({
                                start: timeSlots[firstFreeSlotIndex], // 23:15
                                end: fullTimeSlots[fullTimeSlots.length - 1], // 23:30
                                task: SPECIAL_TASKS.FREE_TASK
                            });
                        }
                    }
                }
            });

            // 9. タスクが0個のスタッフがいないか確認 (UI表示のため)
            staffInGroup.forEach(staff => {
                if (staff.tasks.length === 0) {
                    staff.tasks.push({ start: "", end: "", task: "" });
                }
            });
            
            updateStaffLists();
            window.saveStaffListToFirestore(); 
        }


        /**
         * 全てのスタッフリストのHTMLを再描画します。
         */
        window.updateStaffLists = function() {
            populateStaffList('staff-list-open-early', 'early', 'open', openTimeSlots);
            populateStaffList('staff-list-open-late', 'late', 'open', openTimeSlots);
            populateStaffList('staff-list-close-employee', 'closing_employee', 'close', closeTimeSlots);
            populateStaffList('staff-list-close-alba', 'closing_alba', 'close', closeTimeSlots);
        }

        /**
         * スタッフリストとタスク選択プルダウンを生成して配置します。
         */
        function populateStaffList(containerId, sectionKey, taskListName, timeSlots) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = ''; // コンテナをクリア
            
            const timeSlotJSON = JSON.stringify(timeSlots); // onclick用にJSON文字列化

            window.staffList[sectionKey].forEach((staff, staffIndex) => {
                
                let staffHtml = '';
                const staffName = staff.name.replace(/'/g, "\\'"); // 'エスケープ

                staff.tasks.forEach((task, taskIndex) => {
                    
                    const startBtnText = task.start || '--';
                    const startBtnClass = task.start ? '' : 'placeholder';
                    const endBtnText = task.end || '--';
                    const endBtnClass = task.end ? '' : 'placeholder';
                    const taskBtnText = task.task || '--- タスクを選択 ---';
                    const taskBtnClass = task.task ? '' : 'placeholder';
                    
                    const btnBaseId = `${sectionKey}-${staffIndex}-${taskIndex}`;

                    if (taskIndex === 0) {
                        // 1行目 (スタッフ名 + 最初のタスク)
                        staffHtml += `
                            <tr class="staff-row">
                                <!-- スタッフ名 -->
                                <td class="staff-name-cell" data-label="スタッフ名">
                                    <div class="flex items-center justify-between">
                                        <span>${staff.name}</span>
                                        <button onclick="showDeleteModal('staff', '${sectionKey}', ${staffIndex})" 
                                                class="remove-button" 
                                                title="${staffName} さんを削除">&times;</button>
                                    </div>
                                </td>
                                <!-- 1行目のタスク -->
                                <td data-label="開始">
                                    <button id="start-btn-${btnBaseId}" class="custom-select-button ${startBtnClass}" 
                                            onclick="openTimeSelect('${sectionKey}', ${staffIndex}, ${taskIndex}, 'start', ${timeSlotJSON})">
                                        <span>${startBtnText}</span>
                                    </button>
                                </td>
                                <td data-label="終了">
                                    <button id="end-btn-${btnBaseId}" class="custom-select-button ${endBtnClass}" 
                                            onclick="openTimeSelect('${sectionKey}', ${staffIndex}, ${taskIndex}, 'end', ${timeSlotJSON})">
                                        <span>${endBtnText}</span>
                                    </button>
                                </td>
                                <td data-label="担当タスク">
                                    <button id="task-btn-${btnBaseId}" class="custom-select-button ${taskBtnClass}" 
                                            onclick="openTaskSelect('${sectionKey}', ${staffIndex}, ${taskIndex}, '${taskListName}')">
                                        <span>${taskBtnText}</span>
                                    </button>
                                </td>
                                <td class="task-buttons-cell">
                                    <!-- 1行目でもタスク削除ボタンを配置 (タスクが2個以上の場合のみ) -->
                                    ${staff.tasks.length > 1 ? 
                                        `<button onclick="showDeleteModal('task', '${sectionKey}', ${staffIndex}, ${taskIndex})" 
                                                 class="remove-task-button" 
                                                 title="このタスクを削除">－</button>` : 
                                        `<button onclick="addTask('${sectionKey}', ${staffIndex})" 
                                                 class="add-task-button" 
                                                 title="タスクを追加">+</button>`
                                    }
                                </td>
                            </tr>`;
                    } else {
                        // 2行目以降のタスク
                        staffHtml += `
                            <tr class="task-row">
                                <td class="task-label">
                                    <button onclick="addTask('${sectionKey}', ${staffIndex})" 
                                            class="add-task-button" 
                                            title="タスクを追加">+ タスク追加</button>
                                </td>
                                <td data-label="開始">
                                    <button id="start-btn-${btnBaseId}" class="custom-select-button ${startBtnClass}" 
                                            onclick="openTimeSelect('${sectionKey}', ${staffIndex}, ${taskIndex}, 'start', ${timeSlotJSON})">
                                        <span>${startBtnText}</span>
                                    </button>
                                </td>
                                <td data-label="終了">
                                    <button id="end-btn-${btnBaseId}" class="custom-select-button ${endBtnClass}" 
                                            onclick="openTimeSelect('${sectionKey}', ${staffIndex}, ${taskIndex}, 'end', ${timeSlotJSON})">
                                        <span>${endBtnText}</span>
                                    </button>
                                </td>
                                <td data-label="担当タスク">
                                    <button id="task-btn-${btnBaseId}" class="custom-select-button ${taskBtnClass}" 
                                            onclick="openTaskSelect('${sectionKey}', ${staffIndex}, ${taskIndex}, '${taskListName}')">
                                        <span>${taskBtnText}</span>
                                    </button>
                                </td>
                                <td class="task-buttons-cell">
                                    <button onclick="showDeleteModal('task', '${sectionKey}', ${staffIndex}, ${taskIndex})" 
                                            class="remove-task-button" 
                                            title="このタスクを削除">－</button>
                                </td>
                            </tr>`;
                    }
                });
                
                container.innerHTML += staffHtml;
            });
        }
        
        // --- サマリー表示関数群 (タイムライン版) ---
        
        /**
         * 「割振り確認」タブのタイムラインを生成・表示
         */
        window.generateSummaryView = function() {
            // ★ window.staffList を参照
            const openTasks = [
                ...collectTasks(window.staffList.early),
                ...collectTasks(window.staffList.late)
            ];
            const openStaff = [
                ...new Set([...window.staffList.early.map(s => s.name), ...window.staffList.late.map(s => s.name)])
            ].sort();
            
            // --- 開店作業の描画 ---
            const openHtmlDesktop = createTimelineTable(openTasks, openStaff, openTimeSlots);
            document.getElementById('summary-open-container-desktop').innerHTML = openHtmlDesktop;
            const openHtmlMobile = createTimelineListForMobile(openTasks, openStaff, openTimeSlots);
            document.getElementById('summary-open-container-mobile').innerHTML = openHtmlMobile;
            
            // --- 閉店作業の描画 ---
            const closeTasks = [
                ...collectTasks(window.staffList.closing_employee),
                ...collectTasks(window.staffList.closing_alba)
            ];
             const closeStaff = [
                ...new Set([...window.staffList.closing_employee.map(s => s.name), ...window.staffList.closing_alba.map(s => s.name)])
            ].sort();
            
            const closeHtmlDesktop = createTimelineTable(closeTasks, closeStaff, closeTimeSlots);
            document.getElementById('summary-close-container-desktop').innerHTML = closeHtmlDesktop; 
            const closeHtmlMobile = createTimelineListForMobile(closeTasks, closeStaff, closeTimeSlots);
            document.getElementById('summary-close-container-mobile').innerHTML = closeHtmlMobile;
        }
        
        /**
         * staffListからタスクをフラットな配列に変換
         */
        function collectTasks(staffGroup) {
            let allTasks = [];
            staffGroup.forEach(staff => {
                staff.tasks.forEach(task => {
                    if (task.task) { // タスク名があるもののみ
                        allTasks.push({
                            name: staff.name,
                            ...task
                        });
                    }
                });
            });
            return allTasks;
        }

        /**
         * タイムラインのHTMLテーブルを生成
         */
        function createTimelineTable(tasks, staffNames, timeSlots) {
            if (staffNames.length === 0) {
                return '<p class="p-4 text-center text-gray-500">割り当てられたスタッフがいません。</p>';
            }
            
            // 1. ヘッダー行 (時間)
            let headerHtml = '<tr><th>スタッフ</th>';
            timeSlots.forEach(time => {
                headerHtml += `<th>${time}</th>`;
            });
            headerHtml += '</tr>';
            
            // 2. ボディ行 (スタッフごと)
            let bodyHtml = '';
            staffNames.forEach(name => {
                bodyHtml += `<tr><th>${name}</th>`;
                
                const staffTasks = tasks
                    .filter(t => t.name === name && t.start) // startがあるタスクのみ
                    .sort((a, b) => a.start.localeCompare(b.start)); // 開始時間でソート

                let timeSlotIndex = 0;
                while (timeSlotIndex < timeSlots.length) {
                    const currentTime = timeSlots[timeSlotIndex];
                    
                    // この時間から始まるタスクを探す
                    const task = staffTasks.find(t => t.start === currentTime);
                    
                    if (task && task.end) {
                        // 終了時間があるタスク
                        const startIndex = timeSlotIndex;
                        const endIndex = timeSlots.indexOf(task.end);
                        
                        let colspan = 1;
                        if (endIndex > startIndex) {
                            colspan = endIndex - startIndex; // 07:00-07:15ならcolspan=1
                        }
                        // 終了時間がスロットにない場合
                        if (endIndex === -1) {
                             colspan = 1;
                             console.warn("終了時間がスロットと一致しません:", task);
                        }
                        
                        // ★ タスクバーの色分け
                        let taskClass = '';
                        if (task.task === SPECIAL_TASKS.BRIEFING) taskClass = 'briefing-task';
                        else if (task.task === SPECIAL_TASKS.MONEY_COUNT) taskClass = 'money-task';
                        else if (task.task === SPECIAL_TASKS.FREE_TASK) taskClass = 'free-task';
                        else if (task.task === SPECIAL_TASKS.PARKING) taskClass = 'parking-task'; 
                        else if (task.task === SPECIAL_TASKS.LOCK_CHECK) taskClass = 'lock-task'; // ★追加
                        else if (task.task === SPECIAL_TASKS.TOOLBOX_CHECK) taskClass = 'toolbox-task'; // ★追加
                        else if (task.task === SPECIAL_TASKS.HANDOFF) taskClass = 'handoff-task'; // ★追加
                        else if (task.task.includes('2人')) taskClass = 'pair-task';

                        bodyHtml += `<td colspan="${colspan}">
                                         <div class="task-bar ${taskClass}" title="${task.task} (${task.start}-${task.end})">
                                             ${task.task}
                                         </div>
                                     </td>`; // ★★★ 修正: ここで </td> と ` (バッククォート) を閉じます
                        timeSlotIndex += colspan; // インデックスをジャンプ
                        
                    } else if (task && !task.end) { // ★★★ 修正: "if" を "else if" に変更します
                        // 終了時間がないタスク
                        let taskClass = ''; // 色分け
                        if (task.task === SPECIAL_TASKS.PARKING) taskClass = 'parking-task'; 
                        else if (task.task === SPECIAL_TASKS.LOCK_CHECK) taskClass = 'lock-task'; // ★追加
                        else if (task.task === SPECIAL_TASKS.TOOLBOX_CHECK) taskClass = 'toolbox-task'; // ★追加
                        else if (task.task === SPECIAL_TASKS.HANDOFF) taskClass = 'handoff-task'; // ★追加
                        else if (task.task.includes('2人')) taskClass = 'pair-task';
                        
                         bodyHtml += `<td>
                                         <div class="task-bar ${taskClass}" title="${task.task} (${task.start}-?)">
                                             ${task.task}
                                         </div>
                                     </td>`;
                        timeSlotIndex++;
                        
                    } else {
                        // タスクがない空きスロット
                        bodyHtml += '<td></td>';
                        timeSlotIndex++;
                    }
                }
                
                bodyHtml += '</tr>';
            });

            return `
                <table class="timeline-table">
                    <thead>${headerHtml}</thead>
                    <tbody>${bodyHtml}</tbody>
                </table>
            `;
        }
        
        /**
         * スマホ用のタイムラインリストHTMLを生成
         */
        function createTimelineListForMobile(tasks, staffNames, timeSlots) {
            if (staffNames.length === 0) {
                return '<p class="p-4 text-center text-gray-500">割り当てられたスタッフがいません。</p>';
            }

            let html = '<div class="space-y-4">'; // カード間のスペース

            staffNames.forEach(name => {
                const staffTasks = tasks
                    .filter(t => t.name === name && (t.start || t.task)) // ★タスク名だけでも表示
                    .sort((a, b) => (a.start || '99:99').localeCompare(b.start || '99:99')); // 開始時間でソート

                html += `
                    <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
                        <h3 class="font-semibold text-lg text-gray-800 bg-gray-50 px-4 py-3 border-b border-gray-200">
                            ${name}
                        </h3>
                `;

                if (staffTasks.length === 0) {
                    html += '<p class="px-4 py-3 text-gray-500 text-sm">担当タスクがありません。</p>';
                } else {
                    html += '<ul class="divide-y divide-gray-200">';
                    staffTasks.forEach(task => {
                        
                        // ★ タスクの背景色クラス
                        let pairClass = 'bg-indigo-50 border-l-indigo-400'; // Default
                        if (task.task === SPECIAL_TASKS.BRIEFING) pairClass = 'bg-green-50 border-l-green-400';
                        else if (task.task === SPECIAL_TASKS.MONEY_COUNT) pairClass = 'bg-yellow-50 border-l-yellow-400';
                        else if (task.task === SPECIAL_TASKS.FREE_TASK) pairClass = 'bg-gray-50 border-l-gray-400';
                        else if (task.task === SPECIAL_TASKS.PARKING) pairClass = 'bg-blue-50 border-l-blue-400'; 
                        else if (task.task === SPECIAL_TASKS.LOCK_CHECK || task.task === SPECIAL_TASKS.TOOLBOX_CHECK || task.task === SPECIAL_TASKS.HANDOFF) pairClass = 'bg-purple-50 border-l-purple-400'; // ★追加
                        else if (task.task.includes('2人')) pairClass = 'bg-red-50 border-l-red-400';
                        
                        const timeLabel = (task.start && task.end) ? `${task.start} - ${task.end}` : (task.start ? `${task.start} - ?` : '時間未定');
                        
                        html += `
                            <li class="px-4 py-3 ${pairClass} border-l-4">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-700">${task.task || '(タスク未入力)'}</span>
                                    <span class="text-sm font-mono text-gray-600">${timeLabel}</span>
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                }

                html += '</div>'; // card end
            });

            html += '</div>'; // container end
            return html;
        }

        /**
         * 指定された時間範囲と間隔で時間スロットの配列を生成します。
         */
        function generateTimeSlots(startTime, endTime, intervalMinutes) {
            const slots = [];
            let [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);

            let currentMinutes = startHour * 60 + startMin;
            const endTotalMinutes = endHour * 60 + endMin;

            while (currentMinutes <= endTotalMinutes) {
                const hour = Math.floor(currentMinutes / 60);
                const minute = currentMinutes % 60;
                
                slots.push(
                    `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`
                );
                
                currentMinutes += intervalMinutes;
            }
            return slots;
        }

        // ★グローバル関数を明示的にwindowオブジェクトにアタッチ (安全のため)
        window.showSubTab = showSubTab;
        window.openStaffSelect = openStaffSelect;
        window.addStaff = addStaff;
        window.autoAssignTasks = autoAssignTasks;
        window.openTimeSelect = openTimeSelect;
        window.openTaskSelect = openTaskSelect;
        window.showDeleteModal = showDeleteModal;
        window.addTask = addTask;
        window.cancelDelete = cancelDelete;
        window.confirmDelete = confirmDelete;
        window.closeSelectModal = closeSelectModal;
        window.selectStaff = selectStaff;
        window.selectTask = selectTask;
        window.selectTime = selectTime;
        window.handleChange = handleChange;
        // ★ パスワード用の関数
        window.showPasswordModal = showPasswordModal;
        window.closePasswordModal = closePasswordModal;
        window.checkPassword = checkPassword;
        window.setEditingMode = setEditingMode;

    </script>
</body>
</html>



