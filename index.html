<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>開閉店タスク割り振りBOT</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- ★ Firebase SDK (ここから追加) -->
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase 初期化 ---
        // グローバル変数から設定を取得
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db;
        let userId;
        let unsubscribeFromTasks; // onSnapshotのリスナー解除用

        // Firestoreのドキュメント参照をグローバルに定義
        let taskDocRef;

        /**
         * Firebaseの初期化と認証、データ監視を開始
         */
        async function initFirebase() {
            try {
                // グローバル変数に設定がない場合は、フォールバック（デモ用）
                if (Object.keys(firebaseConfig).length === 0) {
                     console.warn("Firebase config not found. Using placeholder config (this will likely fail outside of a test environment).");
                     // 開発用のダミー設定（インストラクションでは不要だが、ローカルテスト用）
                     // firebaseConfig = { apiKey: "...", authDomain: "...", projectId: "..." };
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Firestoreのデバッグログを有効化

                // Firestoreのパスを定義
                // データは全ユーザー共通（公開）のため、publicパスを使用
                taskDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'task_assignments', 'today');

                // 認証状態の監視
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Firebase Auth: User is signed in.", user.uid);
                        userId = user.uid;
                    } else {
                        console.log("Firebase Auth: User is signed out. Signing in...");
                        // 認証トークンがあればそれを使用、なければ匿名認証
                        if (initialAuthToken) {
                            console.log("Signing in with custom token...");
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            console.log("Signing in anonymously...");
                            await signInAnonymously(auth);
                        }
                        // 認証が成功すると、このonAuthStateChangedリスナーが再度呼ばれる
                    }

                    // 認証が確立したら（userIdがセットされたら）、データ監視を開始
                    if (userId && !unsubscribeFromTasks) { // ★リスナーがまだ開始されていない場合のみ
                        startTaskListener();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                // エラーを画面に表示（オプション）
                const header = document.querySelector('header');
                if(header) {
                    header.innerHTML += `<p class="text-red-500 font-bold">データベース接続エラー</p>`;
                }
            }
        }

        /**
         * Firestoreのタスク割り当てデータの監視を開始
         */
        function startTaskListener() {
            // 既にリスナーがあれば解除
            if (unsubscribeFromTasks) {
                unsubscribeFromTasks();
            }

            console.log("Starting Firestore snapshot listener for:", taskDocRef.path);

            // onSnapshotでリアルタイムのデータ変更を監視
            unsubscribeFromTasks = onSnapshot(taskDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    console.log("Firestore data received:", docSnap.data());
                    // 取得したデータでグローバル変数を上書き
                    const data = docSnap.data();
                    // staffListの各キーが存在するか確認し、なければ空配列で初期化
                    window.staffList.early = data.early || [];
                    window.staffList.late = data.late || [];
                    window.staffList.closing_employee = data.closing_employee || [];
                    window.staffList.closing_alba = data.closing_alba || [];

                } else {
                    console.log("No data found in Firestore. Using default empty list.");
                    // データがない場合（初回など）は空で初期化
                    window.staffList = { early: [], late: [], closing_employee: [], closing_alba: [] };
                }

                // データ更新後、現在のビューを再描画
                // (重要: window.staffListが更新されたことをグローバルスコープに反映させる)
                if (window.refreshCurrentView) {
                     window.refreshCurrentView();
                }

            }, (error) => {
                console.error("Error listening to Firestore:", error);
            });
        }

        /**
         * データをFirestoreに保存 (管理者がログインしている場合のみ)
         */
        async function saveStaffListToFirestore() {
            // (グローバルスコープの) isLoggedIn をチェック
            if (!window.isLoggedIn) {
                console.log("Not logged in. Skipping save to Firestore.");
                return;
            }
            if (!taskDocRef) {
                console.error("Firestore document reference is not initialized.");
                return;
            }

            try {
                console.log("Saving data to Firestore...", window.staffList);
                // (グローバルスコープの) staffList を保存
                // JSON.stringify/parseでシリアライズ/デシリアライズを行い、
                // undefinedなどがFirestore保存時にエラーになるのを防ぐ
                const cleanData = JSON.parse(JSON.stringify(window.staffList));
                await setDoc(taskDocRef, cleanData);
                console.log("Data saved successfully.");
            } catch (error) {
                console.error("Error saving data to Firestore:", error);
            }
        }

        // --- グローバルスコープに関数を公開 ---
        // (HTMLのonclickから呼べるようにするため)
        window.initFirebase = initFirebase;
        window.saveStaffListToFirestore = saveStaffListToFirestore;

    </script>
    <!-- ★ Firebase SDK (ここまで追加) -->

    <style>
        /* モダンデザインのスタイル */
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f4f7fa; 
            color: #334155; 
        }

        /* ★タイトル (黒に変更) */
        h1.title-effect {
            font-size: 2.5rem; /* 4xl (36px) */
            font-weight: 700;
            color: #1e293b; /* Gray-800 (黒っぽい色) */
        }
        @media (min-width: 768px) {
             h1.title-effect {
                font-size: 3rem; /* 5xl (48px) */
             }
        }

        /* タブ (セグメントコントロール風) */
        .tab-container {
            background-color: #e2e8f0; /* Gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.25rem;
            display: flex;
            width: fit-content;
        }
        .tab-button {
            transition: all 0.3s ease;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500;
            color: #475569; /* Gray-600 */
            border: 2px solid transparent;
            font-size: 0.875rem; /* text-sm */
            padding: 0.5rem 1rem;
            white-space: nowrap; /* ★追加 */
        }
        .tab-button.active {
            background-color: #ffffff;
            color: #3b82f6; /* Blue-500 */
            font-weight: 600;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
         @media (min-width: 768px) {
            .tab-button {
                font-size: 1rem; /* text-base */
                padding: 0.75rem 1.5rem;
            }
         }
         
        /* サブタブ (開店・閉店) */
        .sub-tab-button {
             font-size: 0.875rem; /* text-sm */
             padding: 0.5rem 1rem;
        }


        /* セクション (カード風) */
        .task-section {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid #e2e8f0; /* Gray-200 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            overflow: hidden; /* テーブルの角丸のため */
        }
        
        .section-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0; /* Gray-200 */
            background-color: #f8fafc; /* Gray-50 */
        }

        .section-title {
            color: #1e293b; /* Gray-800 */
            font-weight: 600;
            font-size: 1.25rem; /* xl */
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        
        .section-content {
            padding: 1rem;
        }
         @media (min-width: 768px) {
             .section-content {
                padding: 1.5rem;
            }
         }

        /* ボタン共通 (インディゴ) */
        .add-button {
            background-color: #4f46e5; /* Indigo-600 */
            color: #ffffff;
            padding: 0.625rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.15s ease-in-out, box-shadow 0.15s ease;
            white-space: nowrap;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .add-button:hover {
            background-color: #4338ca; /* Indigo-700 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        /* 自動割振り・管理者ボタン (セカンダリ) */
        .secondary-button {
            background-color: #f1f5f9; /* Gray-100 */
            color: #475569; /* Gray-600 */
            border: 1px solid #cbd5e1; /* Gray-300 */
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
         .secondary-button:hover {
            background-color: #e2e8f0; /* Gray-200 */
            box-shadow: none;
         }


        .remove-button {
            background-color: transparent;
            color: #dc2626; /* Red-600 */
            border: 1px solid #ef4444; /* Red-500 */
            border-radius: 9999px; /* rounded-full */
            width: 26px;
            height: 26px;
            font-size: 1.125rem;
            line-height: 1.25;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease-in-out;
            padding-bottom: 2px; /* for &times; centering */
        }
        .remove-button:hover {
            background-color: #dc2626;
            color: #ffffff;
        }
        .remove-task-button {
            width: 22px;
            height: 22px;
            font-size: 1rem;
            color: #64748b; /* Gray-500 */
            border: 1px solid #94a3b8; /* Gray-400 */
            border-radius: 9999px;
        }
         .remove-task-button:hover {
            background-color: #64748b;
            color: #ffffff;
         }
        .add-task-button {
            background-color: #f1f5f9; /* Gray-100 */
            color: #475569; /* Gray-600 */
            border: 1px solid #cbd5e1; /* Gray-300 */
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
        }
        .add-task-button:hover {
            background-color: #e2e8f0; /* Gray-200 */
        }


        /* Table styles (クリーン) */
        .task-table {
            width: 100%;
            border-collapse: collapse; /* ★collapse */
        }

        .task-table th,
        .task-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* Gray-200 */
            vertical-align: middle;
        }
        
        .task-table th {
            font-weight: 600;
            color: #475569; /* Gray-600 */
            text-transform: uppercase;
            font-size: 0.75rem; /* xs */
            letter-spacing: 0.05em;
            background-color: #f8fafc; /* Gray-50 */
        }
        
        /* スタッフ行のスタイル */
        .staff-row td {
            /* 最初のタスク行と同じ */
        }
        /* タスク行のスタイル */
        .task-row td {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px dashed #e2e8f0; /* Gray-200 */
        }
        .task-row:last-child td {
             border-bottom: 1px solid #e2e8f0; /* 最後のタスク行 */
        }
        .task-label {
            text-align: right;
            font-size: 0.875rem;
            color: #64748b;
            padding-right: 0.5rem;
            vertical-align: top;
            padding-top: 0.75rem;
        }
        .staff-name-cell {
            font-weight: 500;
            color: #1e293b;
            font-size: 1.125rem; /* lg */
        }
        
        /* カスタムプルダウン (スマホ対応) */
        .custom-select-button {
            width: 100%;
            text-align: left;
            padding: 0.5rem 0.75rem;
            border: 1px solid #cbd5e1; /* Gray-300 */
            border-radius: 0.375rem;
            background-color: #ffffff;
            min-height: 38px; /* inputの高さと合わせる */
            font-size: 0.875rem; /* text-sm */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* スタッフ追加ボタンのデザイン */
        .staff-select-button {
            padding: 0.625rem 0.75rem; /* 10px 12px */
            min-height: 42px; /* add-buttonと高さを合わせる */
        }
        .staff-select-button.placeholder {
            color: #64748b; /* Gray-500 */
        }
        
        .custom-select-button.placeholder {
            color: #94a3b8; /* Gray-400 */
        }
        .custom-select-button:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .custom-select-button svg {
            width: 1.25rem;
            height: 1.25rem;
            color: #94a3b8;
        }

        /* カスタムモーダル (選択肢用) */
        .select-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        .select-modal-content {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .select-modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
        }
        .select-modal-body {
            overflow-y: auto;
            padding: 0.5rem;
        }
        .select-modal-option {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            border-radius: 0.375rem;
            transition: background-color 0.15s ease-in-out;
            font-size: 1rem;
        }
        .select-modal-option:hover {
            background-color: #f1f5f9; /* Gray-100 */
        }
        .select-modal-option.selected {
            background-color: #dbeafe; /* Blue-100 */
            color: #1d4ed8; /* Blue-700 */
            font-weight: 500;
        }
         .select-modal-option.clear-option {
            color: #64748b;
            font-style: italic;
         }
        .select-modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e2e8f0;
            text-align: right;
        }
        .modal-close-button {
            background-color: #4f46e5; /* Indigo-600 */
            color: #ffffff;
            padding: 0.5rem 1.25rem;
            border-radius: 0.375rem;
            font-weight: 500;
        }
         .modal-close-button:hover {
            background-color: #4338ca;
         }

        
        /* 削除確認・ログインモーダル (共通) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(15, 23, 42, 0.5); /* Slate-900 with 50% opacity */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 400px;
            width: 90%;
        }
        
        /* タイムライン（割振り確認）用スタイル */
        .timeline-container {
            width: 100%;
            overflow-x: auto; /* スマホ用に横スクロール */
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        .timeline-table {
            width: 100%;
            min-width: 1000px; /* 横スクロールを強制 */
            border-collapse: collapse;
        }
        .timeline-table th,
        .timeline-table td {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            height: 3.5rem; /* 高さを固定 */
            text-align: left;
            vertical-align: top;
            font-size: 0.875rem;
        }
        .timeline-table thead th {
            background-color: #f8fafc;
            text-align: center;
            vertical-align: middle;
            font-weight: 600;
            color: #475569;
            min-width: 100px; /* 時間セルの最小幅 */
            white-space: nowrap;
        }
        .timeline-table tbody th { /* スタッフ名セル */
            background-color: #f8fafc;
            font-weight: 600;
            color: #1e293b;
            min-width: 150px;
            white-space: nowrap;
            position: sticky; /* ★スタッフ名をスクロール追従 */
            left: 0;
            z-index: 10;
        }
        .timeline-table tbody td {
            position: relative;
        }
        /* タスクバーのスタイル (インディゴ) */
        .task-bar {
            position: absolute;
            top: 4px;
            left: 2px;
            right: 2px;
            bottom: 4px;
            background-color: #c7d2fe; /* Indigo-200 */
            border: 1px solid #818cf8; /* Indigo-400 */
            color: #3730a3; /* Indigo-800 */
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            z-index: 1;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        /* ペアタスクは色を変える */
        .task-bar.pair-task {
            background-color: #fecaca; /* Red-200 */
            border-color: #f87171; /* Red-400 */
            color: #991b1b; /* Red-800 */
        }


        /* レスポンシブ (スマホ用) */
        @media (max-width: 767px) {
            /* ★管理者ボタンを中央タブの下に移動 */
            .admin-button-container {
                position: static;
                transform: none;
                margin-top: 0.75rem; /* 12px */
                justify-content: center;
                display: flex;
            }
            .main-tab-container {
                flex-direction: column;
                align-items: center;
            }

            .task-table {
                display: block;
                width: 100%;
            }
            .task-table thead {
                display: none; /* テーブルヘッダー非表示 */
            }
            .task-table tbody, .task-table tr, .task-table td {
                display: block;
                width: 100% !important; /* !importantで幅指定を上書き */
                padding: 0;
                border: 0;
            }
            
            .task-table tr {
                border-bottom: 1px solid #e2e8f0;
                margin-bottom: 1.5rem;
                padding-bottom: 1rem;
            }
            .task-table tr:last-child {
                margin-bottom: 0;
                padding-bottom: 0;
                border-bottom: 0;
            }

            .task-table td {
                padding: 0.5rem 0.25rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            /* TDにラベルを追加 */
            .task-table td:before {
                content: attr(data-label);
                font-weight: 600;
                color: #64748b; /* Gray-500 */
                padding-right: 1rem;
                white-space: nowrap;
            }
            
            .staff-name-cell {
                padding: 0.5rem 0.25rem 1rem 0.25rem; /* 名前だけパディング大きめ */
                font-size: 1.25rem;
            }
            .staff-name-cell:before {
                display: none; /* 名前セルはラベル不要 */
            }
            
            .task-label {
                display: none; /* 元のタスクラベルは非表示 */
            }
            
            /* スマホ用のボタン配置 */
            .task-buttons-cell {
                justify-content: space-around; /* ボタンを均等配置 */
                padding-top: 0.5rem;
            }
             .task-buttons-cell:before {
                display: none; /* ラベル不要 */
             }
            
            .remove-button {
                width: 32px;
                height: 32px;
                font-size: 1.25rem;
            }
            .add-task-button, .remove-task-button {
                width: 30px;
                height: 30px;
                font-size: 1.25rem;
                padding: 0;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }

        }

    </style>
</head>
<body class="p-4 md:p-8 lg:p-10">

    <div class="max-w-7xl mx-auto">

        <!-- ヘッダー -->
        <header class="text-center mb-8">
            <h1 class="title-effect tracking-wide">
                開閉店タスク割り振りBOT
            </h1>
        </header>
        
        <!-- メインチブ (セグメントコントロール風) と ログインボタン -->
        <!-- ★変更: main-tab-container追加 -->
        <div class="mb-6 md:mb-8 flex flex-col md:flex-row justify-center items-center relative main-tab-container">
            <div class="tab-container">
                <!-- 「タスク割振り」タブ (最初は非表示) -->
                <button id="tab-assign" class="tab-button hidden" onclick="showTab('assign')">
                    タスク割振り
                </button>
                <button id="tab-summary" class="tab-button active" onclick="showTab('summary')">
                    割振り確認
                </button>
            </div>
            <!-- ログイン/ログアウトボタンエリア -->
            <!-- ★変更: admin-button-container追加, md:absolute -->
            <div class="admin-button-container md:absolute md:right-0 md:top-1/2 md:-translate-y-1/2">
                <button id="show-login-button" class="add-button secondary-button" onclick="showLoginModal()">
                    管理者メニュー
                </button>
                <button id="logout-button" class="add-button secondary-button hidden" onclick="logout()">
                    ログアウト
                </button>
            </div>
        </div>


        <!-- メインコンテンツ -->
        <main>
            <!-- サブタブ（開店・閉店） (セグメントコントロール風) -->
            <!-- ★変更: コンテナごと非表示に -->
            <div id="sub-tab-container" class="mb-6 md:mb-8 flex justify-center hidden">
                <div class="tab-container">
                    <button id="tab-open" class="tab-button sub-tab-button active" onclick="showSubTab('open')">
                        開店作業 (07:00 - 10:00)
                    </button>
                    <button id="tab-close" class="tab-button sub-tab-button" onclick="showSubTab('close')">
                        閉店作業 (22:50 - 23:30)
                    </button>
                </div>
            </div>

            <!-- 「タスク割振り」タブのコンテンツ -->
            <!-- ★変更: hiddenを追加 (デフォルト非表示) -->
            <div id="content-assign" class="space-y-6 md:space-y-8 hidden">
                <!-- 開店作業エリア -->
                <div id="content-open">
                    <!-- カード型セクションに変更 -->
                    <section class="task-section mb-6 md:mb-8">
                        <div class="section-header flex justify-between items-center">
                            <h2 class="section-title">
                                社員・早番
                            </h2>
                            <button onclick="autoAssignTasks('early', 'open')" class="add-button secondary-button">
                                自動割振り
                            </button>
                        </div>
                        <div class="section-content space-y-4">
                            <!-- スタッフ追加フォーム (カスタムモーダル) -->
                            <div class="flex space-x-2">
                                <button id="add-staff-button-early" 
                                        class="custom-select-button staff-select-button placeholder flex-grow" 
                                        onclick="openStaffSelect('early', 'employees')"
                                        data-placeholder="--- 社員を検索・選択 ---">
                                    <span>--- 社員を検索・選択 ---</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <button onclick="addStaff('early')" class="add-button">追加</button>
                            </div>
                            <!-- スタッフ一覧テーブル -->
                            <div>
                                <table class="task-table">
                                    <thead>
                                        <tr>
                                            <th class="w-1/4">スタッフ名</th>
                                            <th class="w-1/6">開始</th>
                                            <th class="w-1/6">終了</th>
                                            <th class="w-2/5">担当タスク</th>
                                            <th class="w-auto"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="staff-list-open-early">
                                        <!-- スタッフ行はJSで描画 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <section class="task-section mb-6 md:mb-8">
                        <div class="section-header flex justify-between items-center">
                            <h2 class="section-title">
                                早番アルバイト
                            </h2>
                            <button onclick="autoAssignTasks('late', 'open')" class="add-button secondary-button">
                                自動割振り
                            </button>
                        </div>
                        <div class="section-content space-y-4">
                            <!-- スタッフ追加フォーム (カスタムモーダル) -->
                            <div class="flex space-x-2">
                                <button id="add-staff-button-late" 
                                        class="custom-select-button staff-select-button placeholder flex-grow" 
                                        onclick="openStaffSelect('late', 'alba_early')"
                                        data-placeholder="--- 早番アルバイトを検索・選択 ---">
                                    <span>--- 早番アルバイトを検索・選択 ---</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <button onclick="addStaff('late')" class="add-button">追加</button>
                            </div>
                            <div>
                                <table class="task-table">
                                    <thead>
                                        <tr>
                                            <th class="w-1/4">スタッフ名</th>
                                            <th class="w-1/6">開始</th>
                                            <th class="w-1/6">終了</th>
                                            <th class="w-2/5">担当タスク</th>
                                            <th class="w-auto"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="staff-list-open-late">
                                        <!-- スタッフ行はJSで描画 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- 閉店作業エリア -->
                <div id="content-close" class="hidden">
                    <section class="task-section mb-6 md:mb-8">
                        <div class="section-header flex justify-between items-center">
                            <h2 class="section-title">
                                社員・遅番
                            </h2>
                             <button onclick="autoAssignTasks('closing_employee', 'close')" class="add-button secondary-button">
                                自動割振り
                            </button>
                        </div>
                        <div class="section-content space-y-4">
                            <!-- スタッフ追加フォーム (カスタムモーダル) -->
                            <div class="flex space-x-2">
                                <button id="add-staff-button-closing_employee" 
                                        class="custom-select-button staff-select-button placeholder flex-grow" 
                                        onclick="openStaffSelect('closing_employee', 'employees')"
                                        data-placeholder="--- 社員を検索・選択 ---">
                                    <span>--- 社員を検索・選択 ---</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <button onclick="addStaff('closing_employee')" class="add-button">追加</button>
                            </div>
                            <div>
                                <table class="task-table">
                                    <thead>
                                        <tr>
                                            <th class="w-1/4">スタッフ名</th>
                                            <th class="w-1/6">開始</th>
                                            <th class="w-1/6">終了</th>
                                            <th class="w-2/5">担当タスク</th>
                                            <th class="w-auto"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="staff-list-close-employee">
                                        <!-- スタッフ行はJSで描画 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <section class="task-section mb-6 md:mb-8">
                        <div class="section-header flex justify-between items-center">
                            <h2 class="section-title">
                                アルバイト・遅番
                            </h2>
                             <button onclick="autoAssignTasks('closing_alba', 'close')" class="add-button secondary-button">
                                自動割振り
                            </button>
                        </div>
                        <div class="section-content space-y-4">
                            <!-- スタッフ追加フォーム (カスタムモーダル) -->
                            <div class="flex space-x-2">
                                <button id="add-staff-button-closing_alba" 
                                        class="custom-select-button staff-select-button placeholder flex-grow" 
                                        onclick="openStaffSelect('closing_alba', 'alba_late')"
                                        data-placeholder="--- 遅番アルバイトを検索・選択 ---">
                                    <span>--- 遅番アルバイトを検索・選択 ---</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <button onclick="addStaff('closing_alba')" class="add-button">追加</button>
                            </div>
                            <div>
                                <table class="task-table">
                                    <thead>
                                        <tr>
                                            <th class="w-1/4">スタッフ名</th>
                                            <th class="w-1/6">開始</th>
                                            <th class="w-1/6">終了</th>
                                            <th class="w-2/5">担当タスク</th>
                                            <th class="w-auto"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="staff-list-close-alba">
                                        <!-- スタッフ行はJSで描画 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
            
            <!-- 「割振り確認」タブのコンテンツ -->
            <!-- ★変更: hiddenを削除 (デフォルト表示) -->
            <div id="content-summary" class="">
                <section class="mb-10">
                    <!-- 見出しとボタンをフレックスボックスで横並びに -->
                    <div class="flex justify-between items-center mb-5">
                        <h2 class="section-title" style="border-color: #4f46e5;">
                            開店作業 タイムライン
                        </h2>
                        <!-- ★CSVダウンロードボタンを削除 -->
                    </div>
                    
                    <!-- ★タイムラインコンテナをPC用とスマホ用に分離 -->
                    <div id="summary-open-container">
                        <!-- PC用 (横スクロール) -->
                        <div id="summary-open-container-desktop" class="timeline-container hidden md:block">
                            <!-- PC用タイムラインはJSで描画 -->
                        </div>
                        <!-- スマホ用 (縦リスト) -->
                        <div id="summary-open-container-mobile" class="md:hidden">
                            <!-- スマホ用リストはJSで描画 -->
                        </div>
                    </div>
                </section>
                
                <section class="mb-10">
                     <!-- 見出しとボタンをフレックスボックスで横並びに -->
                    <div class="flex justify-between items-center mb-5">
                        <h2 class="section-title" style="border-color: #4f46e5;">
                            閉店作業 タイムライン
                        </h2>
                         <!-- ★CSVダウンロードボタンを削除 -->
                    </div>
                    
                     <!-- ★タイムラインコンテナをPC用とスマホ用に分離 -->
                     <div id="summary-close-container">
                        <!-- PC用 (横スクロール) -->
                        <div id="summary-close-container-desktop" class="timeline-container hidden md:block">
                            <!-- PC用タイムラインはJSで描画 -->
                        </div>
                        <!-- スマホ用 (縦リスト) -->
                        <div id="summary-close-container-mobile" class="md:hidden">
                            <!-- スマホ用リストはJSで描画 -->
                        </div>
                     </div>
                </section>
            </div>
            
        </main>

    </div>

    <!-- ログインモーダル (★追加) -->
    <div id="login-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">管理者ログイン</h3>
            <p class="mb-4">パスワードを入力してください。</p>
            <input id="password-input" type="password" class="w-full p-2 border border-gray-300 rounded-md mb-2" placeholder="パスワード">
            <p id="login-error" class="text-red-500 text-sm mb-4 hidden">パスワードが違います。</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeLoginModal()" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300 transition">
                    キャンセル
                </button>
                <button onclick="checkPassword()" class="px-4 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 transition">
                    ログイン
                </button>
            </div>
        </div>
    </div>

    <!-- 削除確認モーダル -->
    <div id="delete-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">削除の確認</h3>
            <p id="delete-modal-message" class="mb-6">本当に削除しますか？</p>
            <div class="flex justify-end space-x-3">
                <button onclick="cancelDelete()" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300 transition">
                    キャンセル
                </button>
                <button id="confirm-delete-button" onclick="confirmDelete()" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700 transition">
                    削除する
                </button>
            </div>
        </div>
    </div>
    
    <!-- カスタム選択モーダル (汎用) -->
    <div id="select-modal" class="select-modal-overlay hidden">
        <div class="select-modal-content">
            <h3 id="select-modal-title" class="select-modal-header"></h3>
            <div id="select-modal-body" class="select-modal-body">
                <!-- 選択肢はJSで描画 -->
            </div>
            <div class="select-modal-footer">
                <button onclick="closeSelectModal()" class="modal-close-button">閉じる</button>
            </div>
        </div>
    </div>


    <script>
        // --- 設定データ ---

        // スタッフのマスター名簿 (PDFから)
        const masterStaffList = {
            employees: [
                // "田村もも乃", "阿部 敏之", "西田在城", "佐藤 大輔", "古場 健悟", 
                // "川野 剛史", "浅野貴之", 
                "関口 周吾", "鈴木優希", "鈴木 達也", 
                "成田 健吾", "柳谷 圭亮", "石山峻冴", "小野坂隼", "若松脩斗", "生沼彪"
            ],
            alba_early: [
                "根岸 麻美", "五十嵐 由衣", "曲山 琴菜", "山北 桃香", "上地佑夏", 
                "中村 仁美", "砂川 愛香", "村上麻衣", "小林夏美", "高橋瑞穂", "細田 竜成"
            ],
            alba_late: [
                "富岡 千尋", "浅羽駿汰", "堀切綾", "大山 真菜", "金田 愛伽", 
                "梅津世那", "高橋 良維河", "立岩昭人"
            ]
        };

        // タスクリスト
        const taskLists = {
            open: [
                "金銭計数",
                "近隣店チェック・外販", // ★変更
                "空調、配電系",
                "抽選準備",
                "抽選",
                "台チェック",
                "販促確認",
                "朝礼" // ★変更
            ],
            close: [
                // "カード点滅つぶし（営業後できるだけ）", // ★削除
                "立駐2人",
                "事務所清掃",
                "島上クイックルワイパー",
                "引継ぎ記載",
                "施錠確認",
                "飲み残し",
                "工具箱チェック",
                // "（営業中）島下確認", // ★削除
                // "（営業中）30π手補給", // ★削除
                // "（営業中）カード点滅つぶし" // ★削除
            ]
        };
        
        // --- アプリケーション状態 ---

        // ★管理者ログイン状態 (グローバルスコープに変更)
        window.isLoggedIn = false;
        const ADMIN_PASSWORD = "admin"; // ★仮パスワード (本番では変更してください)

        // ★タスク割り振りデータ (グローバルスコープに変更)
        // (初期値は空。FirebaseのonSnapshotがデータをロードする)
        window.staffList = {
            early: [],
            late: [],
            closing_employee: [],
            closing_alba: []
        };
        
        // 削除確認用の一時保存
        let deleteInfo = { type: null, sectionKey: null, staffIndex: null, taskIndex: null };
        
        // カスタム選択モーダルのための一時保存
        let currentSelect = {
            type: null, // 'staff', 'task', 'time'
            callback: null,
            buttonEl: null,
            currentValue: null
        };
        // スタッフ追加用の一時保存
        let staffToAdd = {
            early: null,
            late: null,
            closing_employee: null,
            closing_alba: null
        };

        // 時間スロットの事前生成
        const openTimeSlots = generateTimeSlots('07:00', '10:00', 15);
        const closeTimeSlots = generateTimeSlots('22:45', '23:30', 15);

        // --- アプリケーションロジック ---

        document.addEventListener('DOMContentLoaded', () => {
            // ★ Firebaseの初期化を実行
            // (HTML Head内の <script type="module"> で定義)
            if (window.initFirebase) {
                window.initFirebase();
            }

            // ★UI初期設定関数を呼ぶ
            // (注意: この時点ではstaffListは空。FirebaseのonSnapshotがデータをロードすると再描画される)
            setupInitialView();
            
            // モーダル外クリックで閉じる
            document.getElementById('select-modal').addEventListener('click', (event) => {
                if (event.target === document.getElementById('select-modal')) {
                    closeSelectModal();
                }
            });
            
            // ★ログインモーダルでEnterキーを押したときの処理
            document.getElementById('password-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });
        });

        /**
         * ★現在のタブの状態に基づいてビューを再描画する
         * (FirestoreのonSnapshotコールバックやタブ切り替え時に呼ばれる)
         */
        window.refreshCurrentView = function() {
            // 現在アクティブなタブをチェック
            const assignTab = document.getElementById('tab-assign');
            const summaryTab = document.getElementById('tab-summary');

            if (summaryTab.classList.contains('active')) {
                // 「割振り確認」タブが表示されている場合
                console.log("Refreshing Summary View...");
                generateSummaryView();
            } else if (assignTab.classList.contains('active')) {
                // 「タスク割振り」タブが表示されている場合
                console.log("Refreshing Assign View...");
                updateStaffLists();
            } else {
                // (初期ロード時など) デフォルトの「割振り確認」を描画
                console.log("Refreshing Default (Summary) View...");
                generateSummaryView();
            }
        }


        /**
         * ★ページ読み込み時のUI初期状態を設定
         */
        function setupInitialView() {
            window.isLoggedIn = false; // ★window.isLoggedIn に変更
            
            // ログイン状態に依存するUI要素
            document.getElementById('tab-assign').classList.add('hidden');
            document.getElementById('sub-tab-container').classList.add('hidden');
            document.getElementById('show-login-button').classList.remove('hidden');
            document.getElementById('logout-button').classList.add('hidden');
            
            // デフォルトは「割振り確認」タブを表示
            document.getElementById('content-assign').classList.add('hidden');
            document.getElementById('content-summary').classList.remove('hidden');
            
            document.getElementById('tab-assign').classList.remove('active');
            document.getElementById('tab-summary').classList.add('active');
            
            // ★「割振り確認」タブのデータを描画 (onSnapshotが呼ばれると再度更新される)
            generateSummaryView();
        }

        /**
         * ★メインのタブ（割振り/確認）を切り替えます。
         */
        function showTab(tabName) {
            // ログインしていない場合、'assign'タブは見せない
            if (tabName === 'assign' && !window.isLoggedIn) { // ★window.isLoggedIn
                console.warn("管理者としてログインしていません。");
                return; 
            }
            
            const isAssign = tabName === 'assign';
            document.getElementById('content-assign').classList.toggle('hidden', !isAssign);
            document.getElementById('content-summary').classList.toggle('hidden', isAssign);
            
            // ★サブタブコンテナの表示制御を追加
            document.getElementById('sub-tab-container').classList.toggle('hidden', !isAssign);

            document.getElementById('tab-assign').classList.toggle('active', isAssign);
            document.getElementById('tab-summary').classList.toggle('active', !isAssign);
            
            // ★タブ切り替え時に、(既にロード済みの) staffList を使ってビューを再描画
            window.refreshCurrentView();
        }
        
        /**
         * サブのタブ（開店/閉店）を切り替えます。
         */
        function showSubTab(tabName) {
            const isOpen = tabName === 'open';
            document.getElementById('content-open').classList.toggle('hidden', !isOpen);
            document.getElementById('content-close').classList.toggle('hidden', isOpen);
            document.getElementById('tab-open').classList.toggle('active', isOpen);
            document.getElementById('tab-close').classList.toggle('active', !isOpen);
        }
        
        // --- ★ログイン関連 (ここから追加) ---

        /**
         * ログインモーダルを表示
         */
        function showLoginModal() {
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('password-input').value = ""; // 入力欄クリア
            document.getElementById('login-error').classList.add('hidden'); // エラー非表示
            document.getElementById('password-input').focus();
        }

        /**
         * ログインモーダルを閉じる
         */
        function closeLoginModal() {
            document.getElementById('login-modal').classList.add('hidden');
        }

        /**
         * パスワードをチェック
         */
        function checkPassword() {
            const input = document.getElementById('password-input').value;
            const errorEl = document.getElementById('login-error');
            
            if (input === ADMIN_PASSWORD) {
                // 認証成功
                window.isLoggedIn = true; // ★window.isLoggedIn
                closeLoginModal();
                
                // 管理者用UIを表示
                document.getElementById('tab-assign').classList.remove('hidden');
                document.getElementById('show-login-button').classList.add('hidden');
                document.getElementById('logout-button').classList.remove('hidden');
                
                // 「タスク割振り」タブに切り替え
                showTab('assign');
                
            } else {
                // 認証失敗
                errorEl.classList.remove('hidden');
            }
        }
        
        /**
         * ログアウト処理
         */
        function logout() {
            // ★isLoggedIn を false に戻す
            window.isLoggedIn = false;
            // 初期状態に戻す
            setupInitialView();
        }
        // --- (ここまで追加) ---
        

        // --- カスタム選択モーダル関連 ---
        
        /**
         * スタッフ選択モーダルを開きます。
         */
        function openStaffSelect(sectionKey, masterListKey) {
            const masterList = masterStaffList[masterListKey];
            // ★ window.staffList を参照
            const currentStaff = window.staffList[sectionKey].map(s => s.name);
            const selectedStaffName = staffToAdd[sectionKey];
            
            // 既にリストにいるスタッフを除外
            const options = masterList.filter(name => !currentStaff.includes(name));
            
            const modalBody = document.getElementById('select-modal-body');
            modalBody.innerHTML = ''; // クリア
            
            if (options.length === 0) {
                 modalBody.innerHTML = `<div class="p-4 text-center text-gray-500">追加できるスタッフがいません。</div>`;
            } else {
                 options.forEach(name => {
                     const isSelected = name === selectedStaffName;
                     modalBody.innerHTML += `
                         <div class="select-modal-option ${isSelected ? 'selected' : ''}" 
                              onclick="selectStaff('${sectionKey}', '${name.replace(/'/g, "\\'")}')">
                             ${name}
                         </div>`;
                 });
            }
            
            document.getElementById('select-modal-title').textContent = "スタッフを選択";
            document.getElementById('select-modal').classList.remove('hidden');
            
            // 選択状態を保存
            currentSelect = {
                type: 'staff',
                buttonEl: document.getElementById(`add-staff-button-${sectionKey}`),
                callback: (name) => selectStaff(sectionKey, name),
                currentValue: selectedStaffName
            };
        }

        /**
         * モーダルでスタッフを選択
         */
        function selectStaff(sectionKey, staffName) {
            staffToAdd[sectionKey] = staffName;
            
            // ボタンのテキストを更新
            const buttonEl = document.getElementById(`add-staff-button-${sectionKey}`);
            buttonEl.querySelector('span').textContent = staffName;
            buttonEl.classList.remove('placeholder');
            
            closeSelectModal();
        }

        /**
         * タスク選択モーダルを開きます。
         */
        function openTaskSelect(sectionKey, staffIndex, taskIndex, taskListName) {
            const tasks = taskLists[taskListName];
            // ★ window.staffList を参照
            const currentValue = window.staffList[sectionKey][staffIndex].tasks[taskIndex].task;
            
            const modalBody = document.getElementById('select-modal-body');
            modalBody.innerHTML = `<div class="select-modal-option clear-option" onclick="selectTask('', '--- タスクを選択 ---')">--- タスクを選択 ---</div>`; // クリアオプション
            
            tasks.forEach(task => {
                const isSelected = task === currentValue;
                modalBody.innerHTML += `
                    <div class="select-modal-option ${isSelected ? 'selected' : ''}" 
                         onclick="selectTask('${task.replace(/'/g, "\\'")}', '${task.replace(/'/g, "\\'")}')">
                        ${task}
                    </div>`;
            });
            
            document.getElementById('select-modal-title').textContent = "タスクを選択";
            document.getElementById('select-modal').classList.remove('hidden');
            
            // 選択状態を保存
            currentSelect = {
                type: 'task',
                buttonEl: document.getElementById(`task-btn-${sectionKey}-${staffIndex}-${taskIndex}`),
                callback: (value, text) => {
                    handleChange(sectionKey, staffIndex, taskIndex, 'task', value);
                    updateSelectButton(currentSelect.buttonEl, text, value === "");
                },
                currentValue: currentValue
            };
        }
        
        /**
         * 時間選択モーダルを開きます。
         */
        function openTimeSelect(sectionKey, staffIndex, taskIndex, field, timeSlotList) {
            // ★ window.staffList を参照
            const currentValue = window.staffList[sectionKey][staffIndex].tasks[taskIndex][field];
            
            const modalBody = document.getElementById('select-modal-body');
            modalBody.innerHTML = `<div class="select-modal-option clear-option" onclick="selectTime('--')">--</div>`; // クリアオプション
            
            timeSlotList.forEach(time => {
                const isSelected = time === currentValue;
                modalBody.innerHTML += `
                    <div class="select-modal-option ${isSelected ? 'selected' : ''}" 
                         onclick="selectTime('${time}')">
                        ${time}
                    </div>`;
            });
            
            const title = field === 'start' ? '開始時間を選択' : '終了時間を選択';
            document.getElementById('select-modal-title').textContent = title;
            document.getElementById('select-modal').classList.remove('hidden');
            
            // 選択状態を保存
            currentSelect = {
                type: 'time',
                buttonEl: document.getElementById(`${field}-btn-${sectionKey}-${staffIndex}-${taskIndex}`),
                callback: (value) => {
                    handleChange(sectionKey, staffIndex, taskIndex, field, value === '--' ? '' : value);
                    updateSelectButton(currentSelect.buttonEl, value, value === '--');
                },
                currentValue: currentValue
            };
        }
        
        /**
         * モーダルで選択肢を決定（タスク・時間共通）
         */
        function selectTask(value, text) {
            if (currentSelect.callback) {
                currentSelect.callback(value, text);
            }
            closeSelectModal();
        }
        
        function selectTime(value) {
            if (currentSelect.callback) {
                currentSelect.callback(value);
            }
            closeSelectModal();
        }

        /**
         * 選択モーダルを閉じます。
         */
        function closeSelectModal() {
            document.getElementById('select-modal').classList.add('hidden');
            currentSelect = { type: null, callback: null, buttonEl: null, currentValue: null };
        }
        
        /**
         * 選択ボタンの表示を更新
         */
        function updateSelectButton(buttonEl, text, isPlaceholder) {
            if (buttonEl) {
                buttonEl.querySelector('span').textContent = text;
                buttonEl.classList.toggle('placeholder', isPlaceholder);
            }
        }
        
        // --- スタッフ・タスク操作 (★ Firestore保存処理を追加) ---

        /**
         * スタッフをリストに追加します。
         */
        function addStaff(sectionKey) {
            const staffName = staffToAdd[sectionKey];
            if (!staffName) return; // 名前が選択されていない

            // ★ window.staffList を参照
            if (window.staffList[sectionKey].find(staff => staff.name === staffName)) {
                return;
            }

            // ★ window.staffList に追加
            window.staffList[sectionKey].push({
                name: staffName,
                tasks: [{ start: "", end: "", task: "" }]
            });
            
            // 追加フォームをリセット
            staffToAdd[sectionKey] = null;
            const buttonEl = document.getElementById(`add-staff-button-${sectionKey}`);
            updateSelectButton(buttonEl, buttonEl.getAttribute('data-placeholder'), true);

            updateStaffLists();

            // ★ Firestoreに保存
            window.saveStaffListToFirestore();
        }

        /**
         * 特定のスタッフにタスクを追加します。
         */
        function addTask(sectionKey, staffIndex) {
            // ★ window.staffList に追加
            window.staffList[sectionKey][staffIndex].tasks.push({ start: "", end: "", task: "" });
            updateStaffLists();

            // ★ Firestoreに保存
            window.saveStaffListToFirestore();
        }

        /**
         * 削除モーダルを表示します。
         */
        function showDeleteModal(type, sectionKey, staffIndex, taskIndex = null) {
            deleteInfo = { type, sectionKey, staffIndex, taskIndex };
            const modal = document.getElementById('delete-modal');
            const messageEl = document.getElementById('delete-modal-message');
            
            if (type === 'staff') {
                // ★ window.staffList を参照
                const staffName = window.staffList[sectionKey][staffIndex].name;
                messageEl.textContent = `「${staffName}」さんをリストから削除します。よろしいですか？`;
            } else { // type === 'task'
                messageEl.textContent = `このタスクを削除します。よろしいですか？`;
            }
            modal.classList.remove('hidden');
        }

        /**
         * 削除をキャンセルします。
         */
        function cancelDelete() {
            document.getElementById('delete-modal').classList.add('hidden');
            deleteInfo = { type: null, sectionKey: null, staffIndex: null, taskIndex: null };
        }

        /**
         * 削除を確定実行します。
         */
        function confirmDelete() {
            const { type, sectionKey, staffIndex, taskIndex } = deleteInfo;

            if (type === 'staff') {
                // ★ window.staffList から削除
                window.staffList[sectionKey].splice(staffIndex, 1);
            } else if (type === 'task') {
                // タスクが1つの場合は削除させない（代わりにスタッフを削除させる）
                // ★ window.staffList を参照
                if (window.staffList[sectionKey][staffIndex].tasks.length > 1) {
                    // ★ window.staffList から削除
                    window.staffList[sectionKey][staffIndex].tasks.splice(taskIndex, 1);
                }
            }
            
            cancelDelete(); // モーダルを閉じる
            updateStaffLists(); // リストを再描画

            // ★ Firestoreに保存
            window.saveStaffListToFirestore();
        }

        /**
         * タスクや時間の変更をデータに保存します。
         */
        function handleChange(sectionKey, staffIndex, taskIndex, field, value) {
            try {
                // ★ window.staffList を変更
                window.staffList[sectionKey][staffIndex].tasks[taskIndex][field] = value;
                
                // ★ (重要) 変更が完了したタイミングで保存
                window.saveStaffListToFirestore();

            } catch (e) {
                console.error("Error updating data:", {sectionKey, staffIndex, taskIndex, field, value}, e);
            }
        }
        
        /**
         * タスクの自動割振り (★時間設定機能追加 + バグ修正)
         */
        function autoAssignTasks(sectionKey, taskListName) {
            // ★ window.staffList を参照
            const staffInGroup = window.staffList[sectionKey];
            const numStaff = staffInGroup.length;
            
            if (numStaff === 0) {
                // TODO: カスタムアラート
                console.warn("スタッフが追加されていません。");
                return;
            }
            
            const allTasks = [...taskLists[taskListName]];
            const pairTasks = allTasks.filter(t => t.includes('2人'));
            const singleTasks = allTasks.filter(t => !t.includes('2人'));
            
            // 1. 全スタッフのタスクをリセット
            staffInGroup.forEach(staff => staff.tasks = []);
            
            let staffIndex = 0;
            
            // 2. ペアタスクを割り当て
            for (const task of pairTasks) {
                if (staffIndex + 1 < numStaff) {
                    // ペアで割り当て可能
                    staffInGroup[staffIndex].tasks.push({ start: "", end: "", task: task });
                    staffInGroup[staffIndex + 1].tasks.push({ start: "", end: "", task: task });
                    staffIndex += 2;
                } else if (staffIndex < numStaff) {
                    // 1人しか残っていない
                    staffInGroup[staffIndex].tasks.push({ start: "", end: "", task: task });
                    console.warn(`ペアタスク '${task}' は1人に割り当てられました。`);
                    staffIndex++;
                }
                // スタッフが残っていない場合 (staffIndex >= numStaff)、タスクは割り当てられない
            }
            
            // 3. シングルタスクを全員にラウンドロビンで割り当て
            staffIndex = 0; // インデックスをリセット
            for (const task of singleTasks) {
                const staffToAssign = staffInGroup[staffIndex % numStaff];
                staffToAssign.tasks.push({ start: "", end: "", task: task });
                staffIndex++;
            }
            
            // 4. タスクが0個のスタッフがいないか確認 (UI表示のため)
            staffInGroup.forEach(staff => {
                if (staff.tasks.length === 0) {
                    staff.tasks.push({ start: "", end: "", task: "" });
                }
            });
            
            // 5. 時間を割り振る (★修正箇所)
            const timeSlots = (taskListName === 'open') ? openTimeSlots : closeTimeSlots;
            if (timeSlots.length > 1) { // 少なくとも2スロット(1タスク分)必要
                staffInGroup.forEach(staff => {
                    let nextStartTimeIndex = 0;
                    staff.tasks.forEach(task => {
                        // ★修正1: まだ時間が設定されておらず(ペアタスクなどで)、かつ割り当て可能な時間スロットがある場合
                        if (!task.start && nextStartTimeIndex < timeSlots.length - 1) { 
                            // ★修正2: 最後のスロットは開始時間として使わない
                            
                            const startTime = timeSlots[nextStartTimeIndex];
                            const endTime = timeSlots[nextStartTimeIndex + 1]; // 15分後のスロット
                            
                            task.start = startTime;
                            task.end = endTime;
                            
                            // ペアタスクの場合は、ペアの相手も同じ時間にする
                            if (task.task.includes('2人')) {
                                const pairStaff = staffInGroup.find(s => 
                                    s.name !== staff.name && 
                                    s.tasks.some(t => t.task === task.task && !t.start) // まだ時間が設定されてないペアを探す
                                );
                                if (pairStaff) {
                                    const pairTask = pairStaff.tasks.find(t => t.task === task.task && !t.start);
                                    if (pairTask) {
                                        pairTask.start = startTime;
                                        pairTask.end = endTime;
                                    }
                                }
                            }
                            
                            nextStartTimeIndex++; // 次のタスクは次の時間へ
                        }
                    });
                });
            }
            
            updateStaffLists();

            // ★ Firestoreに保存
            window.saveStaffListToFirestore();
        }


        /**
         * 全てのスタッフリストのHTMLを再描画します。
         */
        function updateStaffLists() {
            populateStaffList('staff-list-open-early', 'early', 'open', openTimeSlots);
            populateStaffList('staff-list-open-late', 'late', 'open', openTimeSlots);
            populateStaffList('staff-list-close-employee', 'closing_employee', 'close', closeTimeSlots);
            populateStaffList('staff-list-close-alba', 'closing_alba', 'close', closeTimeSlots);
        }

        /**
         * スタッフリストとタスク選択プルダウンを生成して配置します。
         * カスタムプルダウン(ボタン)に変更
         */
        function populateStaffList(containerId, sectionKey, taskListName, timeSlots) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = ''; // コンテナをクリア
            
            const timeSlotJSON = JSON.stringify(timeSlots); // onclick用にJSON文字列化

            // ★ window.staffList から該当セクションのスタッフを描画
            window.staffList[sectionKey].forEach((staff, staffIndex) => {
                
                let staffHtml = '';
                const staffName = staff.name.replace(/'/g, "\\'"); // 'エスケープ

                staff.tasks.forEach((task, taskIndex) => {
                    
                    const startBtnText = task.start || '--';
                    const startBtnClass = task.start ? '' : 'placeholder';
                    const endBtnText = task.end || '--';
                    const endBtnClass = task.end ? '' : 'placeholder';
                    const taskBtnText = task.task || '--- タスクを選択 ---';
                    const taskBtnClass = task.task ? '' : 'placeholder';
                    
                    const btnBaseId = `${sectionKey}-${staffIndex}-${taskIndex}`;

                    if (taskIndex === 0) {
                        // 1行目 (スタッフ名 + 最初のタスク)
                        staffHtml += `
                            <tr class="staff-row">
                                <!-- スタッフ名 -->
                                <td class="staff-name-cell" data-label="スタッフ名">
                                    <div class="flex items-center justify-between">
                                        <span>${staff.name}</span>
                                        <button onclick="showDeleteModal('staff', '${sectionKey}', ${staffIndex})" 
                                                class="remove-button" 
                                                title="${staffName} さんを削除">&times;</button>
                                    </div>
                                </td>
                                <!-- 1行目のタスク -->
                                <td data-label="開始">
                                    <button id="start-btn-${btnBaseId}" class="custom-select-button ${startBtnClass}" 
                                            onclick="openTimeSelect('${sectionKey}', ${staffIndex}, ${taskIndex}, 'start', ${timeSlotJSON})">
                                        <span>${startBtnText}</span>
                                    </button>
                                </td>
                                <td data-label="終了">
                                    <button id="end-btn-${btnBaseId}" class="custom-select-button ${endBtnClass}" 
                                            onclick="openTimeSelect('${sectionKey}', ${staffIndex}, ${taskIndex}, 'end', ${timeSlotJSON})">
                                        <span>${endBtnText}</span>
                                    </button>
                                </td>
                                <td data-label="担当タスク">
                                    <button id="task-btn-${btnBaseId}" class="custom-select-button ${taskBtnClass}" 
                                            onclick="openTaskSelect('${sectionKey}', ${staffIndex}, ${taskIndex}, '${taskListName}')">
                                        <span>${taskBtnText}</span>
                                    </button>
                                </td>
                                <td class="task-buttons-cell">
                                    <!-- 1行目でもタスク削除ボタンを配置 (タスクが2個以上の場合のみ) -->
                                    ${staff.tasks.length > 1 ? 
                                        `<button onclick="showDeleteModal('task', '${sectionKey}', ${staffIndex}, ${taskIndex})" 
                                                 class="remove-task-button" 
                                                 title="このタスクを削除">－</button>` : 
                                        `<button onclick="addTask('${sectionKey}', ${staffIndex})" 
                                                 class="add-task-button" 
                                                 title="タスクを追加">+</button>`
                                    }
                                </td>
                            </tr>`;
                    } else {
                        // 2行目以降のタスク
                        staffHtml += `
                            <tr class="task-row">
                                <td class="task-label">
                                    <button onclick="addTask('${sectionKey}', ${staffIndex})" 
                                            class="add-task-button" 
                                            title="タスクを追加">+ タスク追加</button>
                                </td>
                                <td data-label="開始">
                                    <button id="start-btn-${btnBaseId}" class="custom-select-button ${startBtnClass}" 
                                            onclick="openTimeSelect('${sectionKey}', ${staffIndex}, ${taskIndex}, 'start', ${timeSlotJSON})">
                                        <span>${startBtnText}</span>
                                    </button>
                                </td>
                                <td data-label="終了">
                                    <button id="end-btn-${btnBaseId}" class="custom-select-button ${endBtnClass}" 
                                            onclick="openTimeSelect('${sectionKey}', ${staffIndex}, ${taskIndex}, 'end', ${timeSlotJSON})">
                                        <span>${endBtnText}</span>
                                    </button>
                                </td>
                                <td data-label="担当タスク">
                                    <button id="task-btn-${btnBaseId}" class="custom-select-button ${taskBtnClass}" 
                                            onclick="openTaskSelect('${sectionKey}', ${staffIndex}, ${taskIndex}, '${taskListName}')">
                                        <span>${taskBtnText}</span>
                                    </button>
                                </td>
                                <td class="task-buttons-cell">
                                    <button onclick="showDeleteModal('task', '${sectionKey}', ${staffIndex}, ${taskIndex})" 
                                            class="remove-task-button" 
                                            title="このタスクを削除">－</button>
                                </td>
                            </tr>`;
                    }
                });
                
                // スマホ用に、タスクが1つの場合の「+」ボタンは1行目に含めるように変更
                
                container.innerHTML += staffHtml;
            });
        }
        
        // --- サマリー表示関数群 (タイムライン版) ---
        
        /**
         * 「割振り確認」タブのタイムラインを生成・表示
         */
        function generateSummaryView() {
            // ★ window.staffList を参照
            const openTasks = [
                ...collectTasks(window.staffList.early),
                ...collectTasks(window.staffList.late)
            ];
            const openStaff = [
                ...new Set([...window.staffList.early.map(s => s.name), ...window.staffList.late.map(s => s.name)])
            ].sort();
            
            // ★PC用とスマホ用で生成先を変更
            // PC用
            const openHtmlDesktop = createTimelineTable(openTasks, openStaff, openTimeSlots);
            document.getElementById('summary-open-container-desktop').innerHTML = openHtmlDesktop;
            // スマホ用
            const openHtmlMobile = createTimelineListForMobile(openTasks, openStaff, openTimeSlots);
            document.getElementById('summary-open-container-mobile').innerHTML = openHtmlMobile;
            
            // 閉店作業
            // ★ window.staffList を参照
            const closeTasks = [
                ...collectTasks(window.staffList.closing_employee),
                ...collectTasks(window.staffList.closing_alba)
            ];
             const closeStaff = [
                ...new Set([...window.staffList.closing_employee.map(s => s.name), ...window.staffList.closing_alba.map(s => s.name)])
            ].sort();
            
            // ★PC用とスマホ用で生成先を変更
            // PC用
            const closeHtmlDesktop = createTimelineTable(closeTasks, closeStaff, closeTimeSlots);
            document.getElementById('summary-open-container-desktop').innerHTML = closeHtmlDesktop;
            // スマホ用
            const closeHtmlMobile = createTimelineListForMobile(closeTasks, closeStaff, closeTimeSlots);
            document.getElementById('summary-close-container-mobile').innerHTML = closeHtmlMobile;
        }
        
        /**
         * staffListからタスクをフラットな配列に変換
         */
        function collectTasks(staffGroup) {
            let allTasks = [];
            staffGroup.forEach(staff => {
                staff.tasks.forEach(task => {
                    if (task.task) { // タスク名があるもののみ
                        allTasks.push({
                            name: staff.name,
                            ...task
                        });
                    }
                });
            });
            return allTasks;
        }

        /**
         * タイムラインのHTMLテーブルを生成
         */
        function createTimelineTable(tasks, staffNames, timeSlots) {
            if (staffNames.length === 0) {
                return '<p class="p-4 text-center text-gray-500">割り当てられたスタッフがいません。</p>';
            }
            
            // 1. ヘッダー行 (時間)
            let headerHtml = '<tr><th>スタッフ</th>';
            timeSlots.forEach(time => {
                headerHtml += `<th>${time}</th>`;
            });
            headerHtml += '</tr>';
            
            // 2. ボディ行 (スタッフごと)
            let bodyHtml = '';
            staffNames.forEach(name => {
                bodyHtml += `<tr><th>${name}</th>`;
                
                const staffTasks = tasks
                    .filter(t => t.name === name && t.start) // startがあるタスクのみ
                    .sort((a, b) => a.start.localeCompare(b.start)); // 開始時間でソート

                let timeSlotIndex = 0;
                while (timeSlotIndex < timeSlots.length) {
                    const currentTime = timeSlots[timeSlotIndex];
                    
                    // この時間から始まるタスクを探す
                    const task = staffTasks.find(t => t.start === currentTime);
                    
                    if (task && task.end) {
                        // 終了時間があるタスク
                        const startIndex = timeSlotIndex;
                        const endIndex = timeSlots.indexOf(task.end);
                        
                        let colspan = 1;
                        if (endIndex > startIndex) {
                            colspan = endIndex - startIndex; // 07:00-07:15ならcolspan=1
                        }
                        // 終了時間がスロットにない場合
                        if (endIndex === -1) {
                             colspan = 1;
                             console.warn("終了時間がスロットと一致しません:", task);
                        }
                        
                        // ペアタスクか判定
                        const isPair = task.task.includes('2人');
                        const pairClass = isPair ? 'pair-task' : '';
                        
                        bodyHtml += `<td colspan="${colspan}">
                                         <div class="task-bar ${pairClass}" title="${task.task} (${task.start}-${task.end})">
                                             ${task.task}
                                         </div>
                                     </td>`;
                        timeSlotIndex += colspan; // インデックスをジャンプ
                        
                    } else if (task && !task.end) {
                        // 終了時間がないタスク
                        const isPair = task.task.includes('2人');
                        const pairClass = isPair ? 'pair-task' : '';
                        
                         bodyHtml += `<td>
                                         <div class="task-bar ${pairClass}" title="${task.task} (${task.start}-?)">
                                             ${task.task}
                                         </div>
                                     </td>`;
                        timeSlotIndex++;
                        
                    } else {
                        // タスクがない空きスロット
                        bodyHtml += '<td></td>';
                        timeSlotIndex++;
                    }
                }
                
                bodyHtml += '</tr>';
            });

            return `
                <table class="timeline-table">
                    <thead>${headerHtml}</thead>
                    <tbody>${bodyHtml}</tbody>
                </table>
            `;
        }
        
        // --- ★スマホ用タイムラインリスト生成 (ここから追加) ---
        /**
         * スマホ用のタイムラインリストHTMLを生成
         */
        function createTimelineListForMobile(tasks, staffNames, timeSlots) {
            if (staffNames.length === 0) {
                return '<p class="p-4 text-center text-gray-500">割り当てられたスタッフがいません。</p>';
            }

            let html = '<div class="space-y-4">'; // カード間のスペース

            staffNames.forEach(name => {
                const staffTasks = tasks
                    .filter(t => t.name === name && (t.start || t.task)) // ★タスク名だけでも表示
                    .sort((a, b) => (a.start || '99:99').localeCompare(b.start || '99:99')); // 開始時間でソート

                html += `
                    <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
                        <h3 class="font-semibold text-lg text-gray-800 bg-gray-50 px-4 py-3 border-b border-gray-200">
                            ${name}
                        </h3>
                `;

                if (staffTasks.length === 0) {
                    html += '<p class="px-4 py-3 text-gray-500 text-sm">担当タスクがありません。</p>';
                } else {
                    html += '<ul class="divide-y divide-gray-200">';
                    staffTasks.forEach(task => {
                        const isPair = task.task.includes('2人');
                        // ★ペアタスクの色分け
                        const pairClass = isPair ? 'bg-red-50 border-l-red-400' : 'bg-indigo-50 border-l-indigo-400';
                        const timeLabel = (task.start && task.end) ? `${task.start} - ${task.end}` : (task.start ? `${task.start} - ?` : '時間未定');
                        
                        html += `
                            <li class="px-4 py-3 ${pairClass} border-l-4">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-700">${task.task || '(タスク未入力)'}</span>
                                    <span class="text-sm font-mono text-gray-600">${timeLabel}</span>
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                }

                html += '</div>'; // card end
            });

            html += '</div>'; // container end
            return html;
        }
        // --- (ここまで追加) ---

        /**
         * 指定された時間範囲と間隔で時間スロットの配列を生成します。
         */
        function generateTimeSlots(startTime, endTime, intervalMinutes) {
            const slots = [];
            let [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);

            let currentMinutes = startHour * 60 + startMin;
            const endTotalMinutes = endHour * 60 + endMin;

            while (currentMinutes <= endTotalMinutes) {
                const hour = Math.floor(currentMinutes / 60);
                const minute = currentMinutes % 60;
                
                slots.push(
                    `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`
                );
                
                currentMinutes += intervalMinutes;
            }
            return slots;
        }

    </script>
</body>
</html>
